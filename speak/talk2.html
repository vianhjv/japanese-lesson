<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BÃ i 2: Thá»ƒ ã¦ & Thá»ƒ ãŸ | Há»c tiáº¿ng Nháº­t cÃ¹ng An</title>
    
<style>
        /* --- Thiáº¿t láº­p cÆ¡ báº£n --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6; margin: 0;  background-color: #f3eadc; 
           }
        .page-header, .page-footer { text-align: center; padding: 20px; }

        /* --- Cáº¥u trÃºc khung cáº£nh --- */
        .scene-container {
            max-width: 900px;
            margin: 20px auto;
            position: relative; /* Äá»ƒ canh chá»‰nh overlay */
        }

        .scene-background-image {
            display: block; 
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* CSS RESPONSIVE */
        .dialogue-overlay {
            position: relative; 
            z-index: 10;
            /* Äiá»u chá»‰nh margin Ã¢m Ä‘á»ƒ Ä‘Ã¨ lÃªn áº£nh má»™t cÃ¡ch há»£p lÃ½ */
            margin-top: -80px; 
            margin-left: 20px;
            margin-right: 20px;
            padding: 25px;
            background: rgba(200, 180, 140, 0.55);  /* Ná»n sÃ¡ng hÆ¡n, Ã­t trong suá»‘t hÆ¡n Ä‘á»ƒ dá»… Ä‘á»c */
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            /* backdrop-filter: blur(5px); Hiá»‡u á»©ng má» ná»n phÃ­a sau (hoáº¡t Ä‘á»™ng trÃªn Safari/Chrome má»›i) */
        }
        
        @media (max-width: 600px) {
            .dialogue-overlay {
                margin-top: -40px; /* Ãt Ä‘Ã¨ lÃªn hÆ¡n trÃªn mobile */
                margin-left: 10px;
                margin-right: 10px;
                padding: 15px;
            }
        }

        .dialogue-display-window {
            color: #333;
            text-align: left;
            min-height: 100px; /* Äáº£m báº£o khung khÃ´ng bá»‹ nháº£y khi Ä‘á»•i ná»™i dung dÃ i ngáº¯n */
            display: flex;
            flex-direction: column;
        }
        
        /* Style cho cÃ¡c thÃ nh pháº§n ná»™i dung há»™i thoáº¡i */
        .speaker-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
        
        }

        .speaker { font-weight: 800; font-size: 1.1rem; margin-right: 10px;}
        /* MÃ u sáº¯c Ä‘áº¡i diá»‡n cho nhÃ¢n váº­t */
        .speaker.suzuki { color: #e67e22; } /* Cam */
        .speaker.tanaka { color: #2980b9; } /* Xanh dÆ°Æ¡ng */
        .speaker.an { color: #e84393; } /* Há»“ng Ä‘áº­m */
        
        .dialogue-content-wrapper {
            display: flex;
            align-items: flex-start; /* CÄƒn hÃ ng trÃªn cÃ¹ng */
            gap: 15px;
        }

        .dialogue-play-btn { 
            background-color: #228B22; /* NÃºt mÃ u xanh lÃ¡ chá»§ Ä‘áº¡o */
            border: none; 
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 1.2rem; cursor: pointer; 
            color: white; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .dialogue-play-btn:hover { background-color: #1e7a1e; transform: scale(1.05); }
        .dialogue-play-btn:active { transform: scale(0.95); }

        .dialogue-texts { flex-grow: 1; }
        
        .japanese-text {
            font-size: clamp(1.2rem, 4vw, 1.6rem); /* TÄƒng kÃ­ch thÆ°á»›c font tiáº¿ng Nháº­t */
            line-height: 1.8;
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-weight: 500;
        }
        
        /* Tá»‘i Æ°u Furigana */
        ruby { ruby-align: center;}
        rt { font-size: 0.6em; color: #7f8c8d; user-select: none; } 

        .vietnamese-text {
            font-size: 1rem;
            color: #555; 
            margin-top: 0;
            font-style: normal;
            border-left: 3px solid #228B22;
            padding-left: 10px;
        }

        /* Highlight khi Ä‘á»c */
        .highlight-word {  
            background-color: #fffa90; 
            border-radius: 4px; 
            box-shadow: 0 0 0 1px #f1c40f; /* Viá»n nháº¹ */
        }

        /* Ngá»¯ phÃ¡p ná»•i báº­t */
        .grammar-point {
            color: #c0392b; 
            font-weight: bold;
            border-bottom: 2px dotted #c0392b; /* Gáº¡ch chÃ¢n cháº¥m bi */
            background-color: rgba(231, 76, 60, 0.05);
            padding: 0 2px;
            border-radius: 3px;
        }

        /* Báº£ng Ä‘iá»u khiá»ƒn */
        .dialogue-nav { 
            display: flex; justify-content: center; align-items: center; gap: 20px;
            margin-top: 20px;  padding-top: 10px;
        }
        #counter { color: #777; font-weight: 500; min-width: 50px; text-align: center; }
        
        .nav-btn { 
            background-color: white; border: 1px solid #ccc; color: #333; 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; 
            font-weight: 500; display: flex; align-items: center; gap: 5px;
        }
        .nav-btn:hover:not(:disabled) { background-color: #f9f9f9; border-color: #999; }
        .nav-btn:disabled { opacity: 0.5; cursor: default; background-color: #f0f0f0; border-color: #ddd;}

    </style>
</head>
<body>

    <div class="page-header">
        <h2>BÃ i 2: Pha cÃ  phÃª (Thá»ƒ ã¦ & Thá»ƒ ãŸ)</h2>
        <p>Luyá»‡n Nghe, NÃ³i, Ngá»¯ phÃ¡p, Tá»« vá»±ng thi JLPT N4</p>
    </div>

    <div class="scene-container">
        <!-- LÆ¯U Ã: Báº¡n hÃ£y thay áº£nh nÃ y báº±ng má»™t áº£nh phÃ¹ há»£p vá»›i bá»‘i cáº£nh pha cÃ  phÃª nhÃ© -->
        <img src="lesson2-An-Tanaka1.jpg" alt="Minh há»a há»™i thoáº¡i: An vÃ  Tanaka pha cÃ  phÃª" class="scene-background-image">

        <div class="dialogue-overlay">
            
            <!-- Khung hiá»ƒn thá»‹ -->
            <div class="dialogue-display-window"></div>

            <!-- Nguá»“n dá»¯ liá»‡u (áº¨n) -->
            <div class="dialogue-source" style="display: none;">
                
                <!-- Line 1 -->
                <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">ç”°ä¸­ (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ãŠã¯ã‚ˆã†ã€ã‚¢ãƒ³ã•ã‚“ã€‚<ruby>é€±æœ«<rt>ã—ã‚…ã†ã¾ã¤</rt></ruby>ã¯ã‚ˆã<span class="grammar-point"><ruby>ä¼‘<rt>ã‚„ã™</rt></ruby>ã‚ã¾ã—ãŸ</span>ã‹ã€‚</p>
                            <p class="vietnamese-text">ChÃ o buá»•i sÃ¡ng, An. Cuá»‘i tuáº§n em Ä‘Ã£ nghá»‰ ngÆ¡i tá»‘t chá»©?</p>
                        </div>
                    </div>
                </div>

                <!-- Line 2 -->
                <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">ã‚¢ãƒ³ (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ã¯ã„ã€<ruby>ç”°ä¸­<rt>ãŸãªã‹</rt></ruby>ã•ã‚“ã€ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚<ruby>é€±æœ«<rt>ã—ã‚…ã†ã¾ã¤</rt></ruby>ã¯<span class="grammar-point"><ruby>ä¼‘<rt>ã‚„ã™</rt></ruby>ã‚“ã§</span>ã€<ruby>å¥½<rt>ã™</rt></ruby>ããª<ruby>æœ¬<rt>ã»ã‚“</rt></ruby>ã‚’<span class="grammar-point"><ruby>èª­<rt>ã‚ˆ</rt></ruby>ã‚“ã§</span>ã€ã¨ã¦ã‚‚<ruby>æ¥½<rt>ãŸã®</rt></ruby>ã—ã‹ã£ãŸã§ã™ã€‚</p>
                            <p class="vietnamese-text">VÃ¢ng, chÃ o buá»•i sÃ¡ng anh Tanaka. Cuá»‘i tuáº§n em Ä‘Ã£ nghá»‰ ngÆ¡i, Ä‘á»c cuá»‘n sÃ¡ch yÃªu thÃ­ch, vui láº¯m áº¡.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 3 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">ç”°ä¸­ (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ãã‚Œã¯ã‚ˆã‹ã£ãŸã€‚ã•ã¦ã€<ruby>æœ<rt>ã‚ã•</rt></ruby>ã®ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®<ruby>å‰<rt>ã¾ãˆ</rt></ruby>ã«ã€ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’<span class="grammar-point">ã„ã‚Œã¦ãã ã•ã„</span>ã€‚</p>
                            <p class="vietnamese-text">Tháº¿ thÃ¬ tá»‘t quÃ¡. NÃ o, trÆ°á»›c cuá»™c há»p sÃ¡ng, em pha cÃ  phÃª giÃºp anh nhÃ©.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 4 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">ã‚¢ãƒ³ (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ã¯ã„ã€<span class="grammar-point">ã‚ã‹ã‚Šã¾ã—ãŸ</span>ã€‚ãˆãˆã¨ã€ã¾ãšã€<ruby>ä½•<rt>ãªã«</rt></ruby>ã‚’ã—ã¾ã™ã‹ã€‚</p>
                            <p class="vietnamese-text">VÃ¢ng, em hiá»ƒu rá»“i áº¡. á»ªm, Ä‘áº§u tiÃªn, em lÃ m gÃ¬ áº¡?</p>
                        </div>
                    </div>
                </div>
                
                <!-- Line 5 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">ç”°ä¸­ (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ã¾ãšã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’<span class="grammar-point">ã‚»ãƒƒãƒˆã—ã¦</span>ã€ãã‚Œã‹ã‚‰ã‚³ãƒ¼ãƒ’ãƒ¼ã®<ruby>ç²‰<rt>ã“ãª</rt></ruby>ã‚’<ruby>å…¥<rt>ã„</rt></ruby>ã‚Œã¾ã™ã€‚</p>
                            <p class="vietnamese-text">Äáº§u tiÃªn, em láº¯p bá»™ lá»c vÃ o, rá»“i cho cÃ  phÃª bá»™t vÃ o.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 6 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">ã‚¢ãƒ³ (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ã¯ã„ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’<span class="grammar-point">ã‚»ãƒƒãƒˆã—ã¦</span>ã€<ruby>ç²‰<rt>ã“ãª</rt></ruby>ã‚’<span class="grammar-point"><ruby>ã„<rt>ã„</rt></ruby>ã‚Œã¾ã—ãŸ</span>ã€‚<ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã¯â€¦ï¼Ÿ</p>
                            <p class="vietnamese-text">VÃ¢ng, em Ä‘Ã£ láº¯p bá»™ lá»c, vÃ  cho bá»™t vÃ o rá»“i áº¡. Tiáº¿p theo lÃ ...?</p>
                        </div>
                    </div>
                </div>

                <!-- Line 7 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">ç”°ä¸­ (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text"><ruby>æ¬¡<rt>ã¤ã</rt></ruby>ã«ã€ãŠ<ruby>æ¹¯<rt>ã‚†</rt></ruby>ã‚’<span class="grammar-point"><ruby>æ²¸<rt>ã‚</rt></ruby>ã‹ã—ã¦</span>ã€ã‚†ã£ãã‚Š<ruby>æ³¨<rt>ãã</rt></ruby>ãã¾ã™ã€‚ã‚ã€ã¡ã‚‡ã£ã¨<span class="grammar-point"><ruby>å¾…<rt>ã¾</rt></ruby>ã£ã¦</span>ã€‚ãã®ã‚«ãƒƒãƒ—ã˜ã‚ƒãªã„ã‚ˆã€‚ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°<ruby>ç”¨<rt>ã‚ˆã†</rt></ruby>ã®ã‚«ãƒƒãƒ—ã‚’<span class="grammar-point"><ruby>ä½¿<rt>ã¤ã‹</rt></ruby>ã£ã¦</span>ã€‚</p>
                            <p class="vietnamese-text">Tiáº¿p theo, em Ä‘un nÆ°á»›c sÃ´i rá»“i tá»« tá»« rÃ³t vÃ o. Ã€, khoan Ä‘Ã£. KhÃ´ng pháº£i cÃ¡i cá»‘c Ä‘Ã³ Ä‘Ã¢u. Em dÃ¹ng cá»‘c dÃ nh cho cuá»™c há»p áº¥y.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Line 8 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">ã‚¢ãƒ³ (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ã‚ã€ã™ã¿ã¾ã›ã‚“ï¼ã¯ã„ã€ã‚«ãƒƒãƒ—ã‚’<span class="grammar-point">ã‹ãˆã¾ã—ãŸ</span>ã€‚</p>
                            <p class="vietnamese-text">Ã, em xin lá»—i! VÃ¢ng, em Ä‘Ã£ Ä‘á»•i cá»‘c rá»“i áº¡.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 9 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">ç”°ä¸­ (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ã†ã‚“ã€ã‚ã‚ŠãŒã¨ã†ã€‚ã‚³ãƒ¼ãƒ’ãƒ¼ã‚’<span class="grammar-point"><ruby>ã„<rt>ã„</rt></ruby>ã‚ŒãŸ</span><ruby>å¾Œ<rt>ã‚ã¨</rt></ruby>ã§ã€<ruby>è³‡æ–™<rt>ã—ã‚Šã‚‡ã†</rt></ruby>ã‚’<ruby>ä¼šè­°å®¤<rt>ã‹ã„ãã—ã¤</rt></ruby>ã«<span class="grammar-point"><ruby>æŒ<rt>ã‚‚</rt></ruby>ã£ã¦<ruby>è¡Œ<rt>ã„</rt></ruby>ã£ã¦</span>ãã ã•ã„ã€‚</p>
                            <p class="vietnamese-text">á»ª, cáº£m Æ¡n em. Sau khi pha cÃ  phÃª xong, em hÃ£y mang tÃ i liá»‡u Ä‘áº¿n phÃ²ng há»p nhÃ©.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 10 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">ã‚¢ãƒ³ (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">ğŸ”Š</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">ã¯ã„ã€<span class="grammar-point"><ruby>æ‰¿çŸ¥<rt>ã—ã‚‡ã†ã¡</rt></ruby>ã—ã¾ã—ãŸ</span>ï¼</p>
                            <p class="vietnamese-text">VÃ¢ng, em rÃµ rá»“i áº¡!</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Äiá»u hÆ°á»›ng -->
            <div class="dialogue-nav">
                <button id="prevBtn" class="nav-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                    LÃ¹i
                </button>
                <span id="counter">1 / 10</span>
                <button id="nextBtn" class="nav-btn">
                    Tiáº¿p
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="page-footer">
        <p>Pháº§n ná»™i dung tiáº¿p theo cá»§a bÃ i há»c...</p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================
    // === PHáº¦N 0: Bá»˜ QUáº¢N LÃ GIá»ŒNG Äá»ŒC (NÃ‚NG Cáº¤P Æ¯U TIÃŠN MICROSOFT) ===
    // =================================================================
    const voiceManager = {
        characterMap: {},
        defaultVoice: null,
        voicesLoaded: false,

        // Cáº¥u hÃ¬nh giá»ng Æ°u tiÃªn (keyword Ä‘á»ƒ tÃ¬m trong tÃªn giá»ng)
        preferences: {
            'an': 'nanami',      // Æ¯u tiÃªn Nanami cho An
            'suzuki': 'haruka',  // Æ¯u tiÃªn Haruka cho Suzuki
            'mio': 'haruka',     // Æ¯u tiÃªn Haruka cho Mio
            'sato': 'sayaka',    // Æ¯u tiÃªn Sayaka cho Sato-sensei
            'yamada': 'ichiro',  // Æ¯u tiÃªn Ichiro cho Yamada-bucho
            'tanaka': 'keita'    // Æ¯u tiÃªn Keita (hoáº·c Ichiro) cho Tanaka
        },

        init: function() {
            // Thá»­ táº£i giá»ng ngay láº­p tá»©c
            this.loadVoices();
            
            // Chrome/Edge cáº§n sá»± kiá»‡n nÃ y Ä‘á»ƒ táº£i danh sÃ¡ch giá»ng Ä‘áº§y Ä‘á»§
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => this.loadVoices();
            }
        },

        loadVoices: function() {
            if (this.voicesLoaded) return; // TrÃ¡nh cháº¡y láº¡i nhiá»u láº§n khÃ´ng cáº§n thiáº¿t

            const allVoices = speechSynthesis.getVoices();
            if (allVoices.length === 0) return; // ChÆ°a cÃ³ giá»ng nÃ o

            // Lá»c giá»ng tiáº¿ng Nháº­t
            const japaneseVoices = allVoices.filter(v => v.lang === 'ja-JP' || v.lang === 'ja_JP');

            if (japaneseVoices.length === 0) {
                console.warn("KhÃ´ng tÃ¬m tháº¥y giá»ng tiáº¿ng Nháº­t.");
                this.voicesLoaded = true;
                return;
            }

            this.defaultVoice = japaneseVoices[0];

            // 1. TÃ¬m cÃ¡c giá»ng Cá»¤ THá»‚ theo yÃªu cáº§u (Microsoft voices)
            const foundPrefVoices = {};
            japaneseVoices.forEach(voice => {
                const voiceNameLower = voice.name.toLowerCase();
                // Kiá»ƒm tra xem giá»ng nÃ y cÃ³ khá»›p vá»›i tá»« khÃ³a Æ°u tiÃªn nÃ o khÃ´ng
                for (const [prefKey, prefKeyword] of Object.entries(this.preferences)) {
                    if (voiceNameLower.includes(prefKeyword)) {
                        foundPrefVoices[prefKeyword] = voice;
                    }
                }
            });

            console.log("TÃ¬m tháº¥y cÃ¡c giá»ng Æ°u tiÃªn:", Object.keys(foundPrefVoices));

            // 2. Táº¡o danh sÃ¡ch dá»± phÃ²ng (Fallback) phÃ¢n loáº¡i Nam/Ná»¯ chung chung
            // Sá»­ dá»¥ng regex Ä‘á»ƒ Ä‘oÃ¡n giá»›i tÃ­nh qua tÃªn phá»• biáº¿n
            const femaleGenerics = japaneseVoices.filter(v => /nanami|haruka|sayaka|ayumi|kyoko|mio/i.test(v.name));
            const maleGenerics = japaneseVoices.filter(v => /ichiro|keita|otoya|kenji|daisuke/i.test(v.name));

            // HÃ m trá»£ giÃºp Ä‘á»ƒ láº¥y giá»ng: Æ¯u tiÃªn -> Dá»± phÃ²ng theo giá»›i tÃ­nh -> Máº·c Ä‘á»‹nh
            const assignVoice = (charId, genderList, fallbackIndex) => {
                const prefKeyword = this.preferences[charId];
                // Táº§ng 1: Náº¿u cÃ³ giá»ng Æ°u tiÃªn cá»¥ thá»ƒ
                if (foundPrefVoices[prefKeyword]) {
                    return foundPrefVoices[prefKeyword];
                }
                // Táº§ng 2: DÃ¹ng danh sÃ¡ch dá»± phÃ²ng theo giá»›i tÃ­nh
                if (genderList.length > 0) {
                    return genderList[fallbackIndex % genderList.length];
                }
                // Táº§ng 3: Giá»ng máº·c Ä‘á»‹nh
                return this.defaultVoice;
            };

            // 3. Thá»±c hiá»‡n gÃ¡n giá»ng cuá»‘i cÃ¹ng
            this.characterMap = {
                'an': assignVoice('an', femaleGenerics, 0),
                'suzuki': assignVoice('suzuki', femaleGenerics, 1),
                'sato': assignVoice('sato', femaleGenerics, 2),
                'mio': assignVoice('mio', femaleGenerics, 1), // DÃ¹ng chung logic dá»± phÃ²ng vá»›i Suzuki
                'yamada': assignVoice('yamada', maleGenerics, 0),
                'tanaka': assignVoice('tanaka', maleGenerics, 1),
            };

            console.log("Báº£n Ä‘á»“ giá»ng Ä‘á»c cuá»‘i cÃ¹ng:", 
                Object.fromEntries(Object.entries(this.characterMap).map(([k, v]) => [k, v.name]))
            );
            
            this.voicesLoaded = true;
            
            // Náº¿u Ä‘ang á»Ÿ slide Ä‘áº§u tiÃªn, táº£i láº¡i Ä‘á»ƒ Ã¡p dá»¥ng giá»ng (phÃ²ng trÆ°á»ng há»£p voices load cháº­m)
            if (typeof activateSpeechForCurrentLine === 'function') {
                activateSpeechForCurrentLine();
            }
        },

        getVoiceFor: function(characterName) {
            if (!this.voicesLoaded) this.loadVoices(); // Cá»‘ gáº¯ng táº£i láº¡i náº¿u chÆ°a cÃ³
            return this.characterMap[characterName] || this.defaultVoice;
        }
    };

    voiceManager.init();


    // =================================================================
    // === PHáº¦N 1: Bá»˜ MÃY Äá»ŒC VÃ€ HIGHLIGHT (Giá»¯ nguyÃªn logic tá»‘t)    ===
    // =================================================================
    let currentSpeechHandler = null;
    
    function createSpeechHandler(targetElement, characterName) {
        // LÆ°u HTML gá»‘c (bao gá»“m tháº» ruby/rt)
        let originalHTML = targetElement.innerHTML;
        let charMap = []; 
        let plainText = '';
        let utterance = null;
        let isPlaying = false;
        let isPaused = false;

        // HÃ m chuáº©n bá»‹: TÃ¡ch tá»«ng kÃ½ tá»± Ä‘á»ƒ highlight, nhÆ°ng giá»¯ nguyÃªn cáº¥u trÃºc Ruby
        function _prepareForSpeech() {
            plainText = '';
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalHTML;

            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    plainText += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // Bá» qua ná»™i dung trong tháº» <rt> (furigana) khi láº¥y plainText Ä‘á»c
                    if (node.tagName === 'RT') return;
                    Array.from(node.childNodes).forEach(processNode);
                }
            }

            processNode(tempDiv);
            
            // Bá»c span cho cÃ¡c kÃ½ tá»± cÃ³ thá»ƒ highlight Ä‘Æ°á»£c
            const tempDivForHighlight = document.createElement('div');
            tempDivForHighlight.innerHTML = originalHTML;

            function wrapCharacters(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const fragment = document.createDocumentFragment();
                    for (const char of node.textContent) {
                        const span = document.createElement('span');
                        span.textContent = char;
                        fragment.appendChild(span);
                    }
                    node.parentNode.replaceChild(fragment, node);
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.tagName === 'RT') return; // KhÃ´ng bá»c furigana
                    Array.from(node.childNodes).forEach(wrapCharacters);
                }
            }
            
            wrapCharacters(tempDivForHighlight);
            targetElement.innerHTML = tempDivForHighlight.innerHTML;
            
            // Láº¥y danh sÃ¡ch táº¥t cáº£ cÃ¡c span cÃ³ thá»ƒ highlight
            charMap = Array.from(targetElement.querySelectorAll('span')).filter(span => {
                 return !span.closest('rt') && !span.classList.contains('grammar-point');
            });
        }

        function _cleanup() {
            // KhÃ´i phá»¥c HTML gá»‘c (xÃ³a cÃ¡c tháº» span highlight)
            targetElement.innerHTML = originalHTML;
            isPlaying = false;
            isPaused = false;
            const btn = displayWindow.querySelector('.dialogue-play-btn');
            if(btn) btn.innerHTML = 'ğŸ”Š'; // Reset icon
        }

        function play() {
            if (currentSpeechHandler && currentSpeechHandler !== this) {
                currentSpeechHandler.stop();
            }
            currentSpeechHandler = this;
            const btn = displayWindow.querySelector('.dialogue-play-btn');

            if (isPlaying && isPaused) {
                speechSynthesis.resume();
                isPaused = false;
                if(btn) btn.innerHTML = 'â¸';
                return;
            }
            
            if (isPlaying && !isPaused) {
                speechSynthesis.pause();
                isPaused = true;
                if(btn) btn.innerHTML = 'â–¶';
                return;
            }
            
            speechSynthesis.cancel();
            
            _prepareForSpeech();
            isPlaying = true;
            isPaused = false;
            if(btn) btn.innerHTML = 'â¸';
            
            utterance = new SpeechSynthesisUtterance(plainText);
            utterance.lang = 'ja-JP';
            utterance.rate = 1; 

            const assignedVoice = voiceManager.getVoiceFor(characterName);
            if (assignedVoice) {
                utterance.voice = assignedVoice;
            }

            utterance.onboundary = (event) => {
                if (event.name !== 'word') return;
                
                const highlighted = targetElement.querySelectorAll('.highlight-word');
                highlighted.forEach(el => el.classList.remove('highlight-word'));

                for (let i = 0; i < event.charLength; i++) {
                    const charIndex = event.charIndex + i;
                    if (charMap[charIndex]) {
                        charMap[charIndex].classList.add('highlight-word');
                    }
                }
            };

            utterance.onend = () => {
                _cleanup();
                currentSpeechHandler = null;
            };
            
            utterance.onerror = (event) => {
                console.error('Lá»—i Ä‘á»c:', event);
                _cleanup();
                currentSpeechHandler = null;
            };
            
            speechSynthesis.speak(utterance);
        }

        function stop() {
            if(isPlaying || isPaused) {
                speechSynthesis.cancel();
                _cleanup();
                currentSpeechHandler = null;
            }
        }

        return { play, stop, get isPlaying() { return isPlaying; } };
    }

    // =================================================================
    // === PHáº¦N 2: ÄIá»€U KHIá»‚N Há»˜I THOáº I (SLIDESHOW)                  ===
    // =================================================================
    const displayWindow = document.querySelector('.dialogue-display-window');
    const sourceLines = document.querySelectorAll('.dialogue-source .dialogue-line');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const counter = document.getElementById('counter');
    
    let currentIndex = 0;
    const totalLines = sourceLines.length;
    let currentLineHandler = null;

    window.activateSpeechForCurrentLine = function() {
        if (currentLineHandler) {
            currentLineHandler.stop();
        }
        
        const currentPlayBtn = displayWindow.querySelector('.dialogue-play-btn');
        const currentTextElement = displayWindow.querySelector('.japanese-text');
        const currentSpeakerElement = displayWindow.querySelector('.speaker');

        if (currentPlayBtn && currentTextElement && currentSpeakerElement) {
            const characterName = currentSpeakerElement.dataset.character;
            currentLineHandler = createSpeechHandler(currentTextElement, characterName);
            
            const newBtn = currentPlayBtn.cloneNode(true);
            currentPlayBtn.parentNode.replaceChild(newBtn, currentPlayBtn);
            
            newBtn.addEventListener('click', () => {
                currentLineHandler.play();
            });
        }
    }

    function showLine(index) {
        if (index >= 0 && index < totalLines) {
            displayWindow.style.opacity = 0;
            
            setTimeout(() => {
                if (currentLineHandler) currentLineHandler.stop();
                displayWindow.innerHTML = sourceLines[index].innerHTML;
                window.activateSpeechForCurrentLine(); 
                counter.textContent = `${index + 1} / ${totalLines}`;
                
                updateNavButtons();
                displayWindow.style.opacity = 1; 
            }, 150);
        }
    }
    
    displayWindow.style.transition = 'opacity 0.15s ease';

    function updateNavButtons() {
        prevBtn.disabled = (currentIndex === 0);
        nextBtn.disabled = (currentIndex === totalLines - 1);
    }

    nextBtn.addEventListener('click', () => {
        if (currentIndex < totalLines - 1) {
            currentIndex++;
            showLine(currentIndex);
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            showLine(currentIndex);
        }
    });

    // Khá»Ÿi cháº¡y
    if (totalLines > 0) {
        showLine(0);
    }
});
</script>
</body>
</html>
