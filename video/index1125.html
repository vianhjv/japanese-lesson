<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán T·∫≠p H·ªôi Tho·∫°i Ti·∫øng Nh·∫≠t</title>
    <link rel="stylesheet" href="styles-video.css">
    
    <!-- CSS ri√™ng cho c√°c n√∫t b·∫•m (Gi·ªØ nguy√™n nh∆∞ b·∫°n ƒëang d√πng) -->
    <style>
        .controls {
            display: flex; flex-wrap: wrap; justify-content: space-around;
            gap: 5px; padding: 10px 5px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }
        .controls .btn {
            flex: 1; justify-content: center; min-width: 70px;
            font-size: 13px; padding: 10px 4px;
            white-space: nowrap;
        }
        /* M√†u s·∫Øc ph√¢n bi·ªát cho 4 n√∫t */
        .btn-jp { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; }
        .btn-vn { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .btn-pause { background: #fff3e0; color: #ef6c00; border: 1px solid #ffcc80; }
        .btn-stop { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        
        /* CSS cho Menu Dropdown m·ªõi */
        .lesson-selector {
            position: absolute; 
            top: 15px; left: 15px; 
            z-index: 100;
            max-width: 80%;
        }
        .lesson-selector select {
            padding: 10px 15px; 
            border-radius: 25px; 
            border: 2px solid #fff; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
            font-weight: bold; 
            font-size: 14px; 
            background: rgba(255,255,255,0.95);
            color: #333;
            outline: none;
            width: 100%;
        }
    </style>
</head>
<body>

    <!-- KHU V·ª∞C 1: ·∫¢NH MINH H·ªåA (50%) -->
    <div class="media-stage">
        <!-- Menu ch·ªçn b√†i d·∫°ng Drop-down (M·ªöI) -->
        <div class="lesson-selector">
            <select id="lessonSelect" onchange="loadLesson(this.value)">
                <option value="">-- ƒêang t·∫£i danh s√°ch b√†i... --</option>
            </select>
        </div>

        <img id="bgImg" class="media-content" src="" alt="Minh h·ªça" style="display:none;">
        <video id="bgVid" class="media-content" style="display:none;" controls></video>
    </div>

    <!-- KHU V·ª∞C 2: L·ªúI THO·∫†I (50%) -->
    <div class="script-stage" id="scriptContent">
        <div style="text-align: center; color: #888; padding-top: 60px;">
            <p>ƒêang t·∫£i b√†i h·ªçc...</p>
        </div>
    </div>

    <!-- KHU V·ª∞C 3: THANH ƒêI·ªÄU KHI·ªÇN (4 N√öT - GI·ªÆ NGUY√äN) -->
    <div class="controls">
        <button class="btn btn-jp" onclick="playMode('jp')">
            üáØüáµ Nghe Nh·∫≠t
        </button>
        <button class="btn btn-vn" onclick="playMode('vn')">
            üáªüá≥ Nghe Vi·ªát
        </button>
        <button class="btn btn-pause" onclick="togglePause()">
            ‚è∏ T·∫°m d·ª´ng
        </button>
        <button class="btn btn-stop" onclick="stopPlayer()">
            ‚èπ D·ª´ng l·∫°i
        </button>
    </div>

    <!-- SCRIPT -->
    <script src="data.js"></script>
    <script src="script-video.js"></script>

    <script>
        // --- LOGIC GIAO DI·ªÜN M·ªöI ---
        
        window.onload = async function() {
            // 1. Ki·ªÉm tra d·ªØ li·ªáu
            if (typeof lessonData === 'undefined') {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y data.js. H√£y ki·ªÉm tra l·∫°i file."); return;
            }

            // 2. Kh·ªüi t·∫°o gi·ªçng n√≥i (ƒë·ª£i load xong)
            await voiceManager.init();
            
            // 3. T·∫°o Menu Dropdown
            const sel = document.getElementById('lessonSelect');
            sel.innerHTML = '<option value="">-- üìö Ch·ªçn b√†i h·ªçc ƒë·ªÉ √¥n t·∫≠p --</option>'; // Reset
            
            lessonData.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.id; 
                opt.textContent = l.title; // V√≠ d·ª•: "B√†i 1: Ch√†o h·ªèi"
                sel.appendChild(opt);
            });

            // 4. [M·ªöI] T·ª± ƒë·ªông load b√†i ƒë·∫ßu ti√™n (ƒë·ªÉ m√†n h√¨nh kh√¥ng b·ªã ƒëen)
            if(lessonData.length > 0) {
                const firstLessonId = lessonData[0].id;
                sel.value = firstLessonId; // Ch·ªçn s·∫µn tr√™n menu
                loadLesson(firstLessonId); // Hi·ªÉn th·ªã n·ªôi dung ngay
            }
        };

        // H√†m hi·ªÉn th·ªã b√†i h·ªçc
        function loadLesson(id) {
            if(!id) return;
            stopPlayer(); // D·ª´ng b√†i c≈© n·∫øu ƒëang ƒë·ªçc

            const lesson = lessonData.find(l => l.id === id);
            if(!lesson) return;
            
            // 1. X·ª≠ l√Ω Media (·∫¢nh/Video)
            const img = document.getElementById('bgImg');
            const vid = document.getElementById('bgVid');
            if(lesson.mediaUrl && lesson.mediaUrl.match(/\.(mp4|webm)$/i)) {
                vid.src = lesson.mediaUrl; vid.style.display='block'; img.style.display='none';
            } else {
                img.src = lesson.mediaUrl || ''; img.style.display='block'; vid.style.display='none';
            }

            // 2. X·ª≠ l√Ω L·ªùi tho·∫°i (Script)
            const container = document.getElementById('scriptContent');
            container.innerHTML = '';
            
            const lines = (lesson.script || "").split('\n').filter(l => l.trim());
            const parsedLines = [];
            let lastChar = '', isLeft = true;

            lines.forEach((line, idx) => {
                // T√°ch T√™n: N·ªôi dung
                const parts = line.split(':');
                if(parts.length < 2) return;
                
                const charName = parts[0].trim();
                const contentBody = parts.slice(1).join(':'); // L·∫•y ph·∫ßn sau d·∫•u :
                const contentParts = contentBody.split('|');
                
                const jp = contentParts[0].trim();
                const vn = contentParts[1] ? contentParts[1].trim() : "";

                // ƒê·ªïi b√™n n·∫øu ƒë·ªïi ng∆∞·ªùi n√≥i
                if(lastChar && charName !== lastChar) isLeft = !isLeft;
                lastChar = charName;

                // HTML bong b√≥ng chat
                const div = document.createElement('div');
                div.className = `row ${isLeft ? 'left' : 'right'} t${(idx % 3) + 1}`;
                div.id = `line-${idx}`;
                div.innerHTML = `
                    <div class="avatar">${charName.charAt(0)}</div>
                    <div class="bubble">
                        <div class="japanese-text" id="jp-text-${idx}">${jp}</div>
                        ${vn ? `<span class="vietnamese-text" id="vn-text-${idx}">${vn}</span>` : ''}
                    </div>
                `;
                
                // Click d√≤ng n√†o ƒë·ªçc d√≤ng ƒë√≥ (M·∫∑c ƒë·ªãnh ƒë·ªçc Ti·∫øng Nh·∫≠t)
                div.onclick = () => {
                    stopPlayer();
                    playerState.currentIndex = idx;
                    playerState.mode = 'jp'; 
                    playerState.isPlaying = true;
                    speakNext();
                };

                container.appendChild(div);
                parsedLines.push({ index: idx, char: charName, jpId: `jp-text-${idx}`, vnId: `vn-text-${idx}`, rowId: `line-${idx}` });
            });

            // 3. N·∫°p d·ªØ li·ªáu v√†o m√°y ƒë·ªçc
            initPlayer(parsedLines, lesson.voiceConfig);
        }
    </script>
</body>
</html>