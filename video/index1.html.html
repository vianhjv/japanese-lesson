<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán Nghe H·ªôi Tho·∫°i JLPT</title>
    <link rel="stylesheet" href="styles-video.css">
    <style>
        /* --- CSS RI√äNG CHO TRANG PLAYER (MENU) --- */
        
        /* N√∫t m·ªü Menu (Hamburger) */
        .menu-btn {
            position: absolute; top: 15px; left: 15px; z-index: 200;
            background: rgba(0,0,0,0.6); color: white;
            border: none; padding: 8px 12px; border-radius: 5px;
            font-size: 20px; cursor: pointer;
        }

        /* Khung Menu tr∆∞·ª£t t·ª´ tr√°i sang */
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100%; width: 280px;
            background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            z-index: 300; transform: translateX(-100%); transition: 0.3s;
            display: flex; flex-direction: column;
        }
        .sidebar.open { transform: translateX(0); }

        .sidebar-header {
            padding: 20px; background: var(--primary); color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }

        .lesson-list {
            flex: 1; overflow-y: auto; padding: 10px;
        }
        .lesson-item {
            padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer;
            transition: 0.2s; border-radius: 5px;
        }
        .lesson-item:hover { background-color: #f0f2f5; color: var(--primary); font-weight: bold; }
        .lesson-item.active { background-color: #e3f2fd; color: var(--primary); font-weight: bold; border-left: 4px solid var(--primary); }

        /* M√†n che m·ªù khi m·ªü menu */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 250;
            display: none;
        }
        .overlay.show { display: block; }
        
        /* Ti√™u ƒë·ªÅ b√†i h·ªçc hi·ªán t·∫°i (N·ªïi tr√™n ·∫£nh) */
        .current-lesson-title {
            position: absolute; top: 10px; right: 10px; z-index: 100;
            background: rgba(0,0,0,0.6); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 14px; pointer-events: none;
        }
    </style>
</head>
<body>

    <!-- 1. C√ÅC TH√ÄNH PH·∫¶N ƒêI·ªÄU H∆Ø·ªöNG -->
    <button class="menu-btn" onclick="toggleMenu()">‚ò∞ Danh s√°ch b√†i</button>
    <div class="current-lesson-title" id="displayTitle">Ch·ªçn b√†i h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu</div>

    <div class="overlay" onclick="toggleMenu()" id="siteOverlay"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0">üìö Ch·ªçn B√†i H·ªçc</h3>
            <button class="close-btn" onclick="toggleMenu()">√ó</button>
        </div>
        <div class="lesson-list" id="lessonList">
            <!-- Danh s√°ch b√†i h·ªçc s·∫Ω ƒë∆∞·ª£c JS t·∫°o ra ·ªü ƒë√¢y -->
        </div>
    </div>

    <!-- 2. KHU V·ª∞C HI·ªÇN TH·ªä (PLAYER - Gi·ªëng h·ªát Maker) -->
    <div class="media-stage">
        <img id="bgImg" class="media-content" src="" style="display:none;">
        <video id="bgVid" class="media-content" src="" style="display:none;" loop playsinline muted></video>
    </div>

    <div class="script-stage">
        <div id="scriptContent" class="script-content">
            <div style="text-align: center; padding-top: 50px; color: #999;">
                <p>Vui l√≤ng ch·ªçn b√†i h·ªçc t·ª´ menu b√™n tr√°i<br>ƒë·ªÉ b·∫Øt ƒë·∫ßu luy·ªán t·∫≠p.</p>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="btn" onclick="playAll('jp')">üáØüáµ Nghe Nh·∫≠t</button>
        <button class="btn" onclick="playAll('vn')">üáªüá≥ Nghe Vi·ªát</button>
        <button class="btn" id="btnPause" onclick="togglePause()">‚è∏ Pause</button>
        <button class="btn" onclick="stopPlayer()">‚èπ Stop</button>
    </div>

    <!-- LOAD C√ÅC FILE LOGIC -->
    <script src="data.js"></script>
    <script src="script-video.js"></script>

    <script>
        // --- LOGIC RI√äNG C·ª¶A TRANG PLAYER ---

        // 1. Kh·ªüi t·∫°o
        window.onload = async function() {
            await voiceManager.init();
            renderLessonList();
            
            // T·ª± ƒë·ªông load b√†i ƒë·∫ßu ti√™n n·∫øu mu·ªën
            // if(lessonData.length > 0) loadLesson(lessonData[0].id);
        };

        // 2. X·ª≠ l√Ω Menu Sidebar
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('siteOverlay').classList.toggle('show');
        }

        // 3. Render danh s√°ch b√†i h·ªçc
        function renderLessonList() {
            const list = document.getElementById('lessonList');
            list.innerHTML = '';
            
            if (typeof lessonData === 'undefined' || lessonData.length === 0) {
                list.innerHTML = '<div style="padding:15px; color:red;">Ch∆∞a c√≥ d·ªØ li·ªáu data.js</div>';
                return;
            }

            lessonData.forEach((l, index) => {
                const item = document.createElement('div');
                item.className = 'lesson-item';
                item.textContent = l.title;
                item.onclick = () => {
                    loadLesson(l.id);
                    toggleMenu(); // ƒê√≥ng menu sau khi ch·ªçn
                    
                    // Highlight item ƒëang ch·ªçn
                    document.querySelectorAll('.lesson-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                };
                list.appendChild(item);
            });
        }

        // 4. Load b√†i h·ªçc & Chuy·ªÉn ƒë·ªïi sang HTML
        function loadLesson(id) {
            const lesson = lessonData.find(l => l.id === id);
            if(!lesson) return;

            // C·∫≠p nh·∫≠t th√¥ng tin c∆° b·∫£n
            document.getElementById('displayTitle').innerText = lesson.title;
            
            // X·ª≠ l√Ω Media
            const img = document.getElementById('bgImg');
            const vid = document.getElementById('bgVid');
            const mediaUrl = lesson.mediaUrl;
            
            if(mediaUrl && mediaUrl.match(/\.(mp4|webm)$/i)) {
                vid.src = mediaUrl; vid.style.display='block'; img.style.display='none'; 
                // vid.play(); // L∆∞u √Ω: M·ªôt s·ªë tr√¨nh duy·ªát ch·∫∑n autoplay n·∫øu ch∆∞a t∆∞∆°ng t√°c
            } else {
                img.src = mediaUrl || ''; img.style.display='block'; vid.style.display='none';
            }

            // X·ª≠ l√Ω Script HTML (Logic render gi·ªëng h·ªát Maker)
            const container = document.getElementById('scriptContent');
            container.innerHTML = '';
            const scriptLines = [];
            const lines = lesson.script.split('\n').filter(l => l.trim());
            
            let lastChar = ''; let isLeft = true;
            lines.forEach((line, idx) => {
                const firstColon = line.indexOf(':');
                if(firstColon === -1) return;
                const charName = line.substring(0, firstColon).trim();
                const content = line.substring(firstColon + 1);
                const parts = content.split('|');
                
                if(lastChar && charName !== lastChar) isLeft = !isLeft;
                lastChar = charName;

                const div = document.createElement('div');
                div.className = `row ${isLeft ? 'left' : 'right'} t${(idx % 3) + 1}`;
                div.id = `line-${idx}`;
                div.innerHTML = `
                    <div class="avatar">${charName.charAt(0)}</div>
                    <div class="bubble">
                        <div class="japanese-text" id="jp-text-${idx}">${parts[0].trim()}</div>
                        ${parts[1] ? `<span class="vietnamese-text" id="vn-text-${idx}">${parts[1].trim()}</span>` : ''}
                    </div>
                `;
                
                // Click d√≤ng n√†o ƒë·ªçc d√≤ng ƒë√≥
                div.onclick = () => {
                     stopPlayer();
                     // Set tr·∫°ng th√°i v√†o bi·∫øn global trong script.js
                     // Ch√∫ng ta c·∫ßn truy c·∫≠p bi·∫øn playerState t·ª´ script.js. 
                     // L∆∞u √Ω: Bi·∫øn playerState c·∫ßn ƒë∆∞·ª£c expose ho·∫∑c h√†m playAt c·∫ßn ƒë∆∞·ª£c vi·∫øt.
                     // ·ªû phi√™n b·∫£n ƒë∆°n gi·∫£n n√†y, ta set tr·ª±c ti·∫øp:
                     if(typeof playerState !== 'undefined') {
                        playerState.currentIndex = idx;
                        playerState.isPlaying = true;
                        speakNext();
                     }
                };
                container.appendChild(div);
                scriptLines.push({ index: idx, char: charName, jpId: `jp-text-${idx}`, vnId: `vn-text-${idx}`, rowId: `line-${idx}` });
            });

            // Kh·ªüi t·∫°o Player
            // L∆∞u √Ω: lesson.voiceConfig l√† c·∫•u h√¨nh gi·ªçng b·∫°n ƒë√£ l∆∞u t·ª´ Maker
            initPlayer(scriptLines, lesson.voiceConfig);
        }
    </script>
</body>
</html>