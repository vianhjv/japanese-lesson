<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Ghép Miệng Anime (V2 - Smart Patch)</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: row;
            justify-content: center;
            padding: 20px;
            gap: 20px;
        }
        .canvas-area {
            position: relative;
        }
        canvas {
            border: 2px solid #ecf0f1;
            background-image: linear-gradient(45deg, #808080 25%, transparent 25%), linear-gradient(-45deg, #808080 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #808080 75%), linear-gradient(-45deg, transparent 75%, #808080 75%);
            background-size: 20px 20px;
            cursor: move; /* Con trỏ di chuyển */
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .controls {
            background: #34495e;
            padding: 20px;
            border-radius: 8px;
            width: 320px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .section {
            margin-bottom: 15px;
            border-bottom: 1px solid #46637f;
            padding-bottom: 10px;
        }
        .section h3 { margin: 0 0 10px 0; font-size: 1rem; color: #f1c40f; }
        
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #bdc3c7; }
        input[type="range"] { width: 100%; cursor: pointer; }
        input[type="file"] { width: 100%; font-size: 0.8em; margin-bottom: 5px; }
        
        button {
            width: 100%; padding: 12px; margin-top: 10px; cursor: pointer;
            background: #27ae60; color: white; border: none; border-radius: 4px; 
            font-weight: bold; font-size: 1rem; transition: 0.2s;
        }
        button:hover { background: #2ecc71; transform: scale(1.02); }
        button.stop { background: #c0392b; }
        
        .row { display: flex; gap: 10px; align-items: center; }
        .color-preview { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; display: inline-block; vertical-align: middle;}
    </style>
</head>
<body>

    <div class="canvas-area">
        <canvas id="mainCanvas" width="600" height="600"></canvas>
        <div style="text-align: center; margin-top: 10px; color: #ccc;">
            Kéo chuột để di chuyển miệng • Lăn chuột để phóng to/thu nhỏ
        </div>
    </div>

    <div class="controls">
        <div class="section">
            <h3>1. Tải ảnh & Chọn da</h3>
            <input type="file" id="uploadChar" accept="image/*">
            <input type="file" id="uploadMouth" accept="image/*">
            <div style="margin-top: 10px;">
                <label>Màu da (Click vào mặt để lấy):</label>
                <div class="row">
                    <div id="colorPreview" class="color-preview" style="background: #f2cca7;"></div>
                    <input type="text" id="hexValue" value="#f2cca7" style="width: 70px; text-align: center;">
                </div>
            </div>
        </div>

        <div class="section">
            <h3>2. Chỉnh Miệng (Mouth)</h3>
            <label>Độ to nhỏ (Scale): <span id="valScale">1.0</span></label>
            <input type="range" id="scaleSlider" min="0.1" max="3.0" step="0.05" value="1.0">
            
            <label>Tốc độ nói (Speed):</label>
            <input type="range" id="speedSlider" min="50" max="300" step="10" value="120">
        </div>

        <div class="section" style="background: #2c3e50; padding: 10px; border-radius: 5px; border: 1px solid #f1c40f;">
            <h3 style="color: #fff;">3. Tinh chỉnh Miếng Vá (Patch)</h3>
            <label style="color: #aaa; font-size: 0.8em; margin-bottom: 8px;">
                <i>Chỉnh cái này nhỏ lại để không đè lên cằm</i>
            </label>

            <label><input type="checkbox" id="chkShowPatch" checked> Bật miếng vá</label>
            <label><input type="checkbox" id="chkRoundPatch" checked> Dùng hình Bầu dục (Mềm hơn)</label>
            
            <label>Chiều rộng vá (Width):</label>
            <input type="range" id="patchW" min="0.1" max="1.5" step="0.05" value="0.7">
            
            <label>Chiều cao vá (Height):</label>
            <input type="range" id="patchH" min="0.1" max="1.5" step="0.05" value="0.5">
            
            <label>Dịch chuyển dọc (Offset Y):</label>
            <input type="range" id="patchOffY" min="-50" max="50" step="1" value="5">
        </div>

        <button id="btnTalk" onclick="toggleTalk()">▶ BẮT ĐẦU NÓI</button>
    </div>

    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        
        // --- CONFIG & STATE ---
        let assets = {
            char: new Image(),
            mouth: new Image(),
            charLoaded: false,
            mouthLoaded: false
        };

        let state = {
            talking: false,
            timer: null,
            frameIndex: 0,
            
            // Mouth Transform
            x: 300, y: 300,
            scale: 1.0,
            speed: 120,

            // Patch Config
            patchColor: '#f2cca7',
            patchEnabled: true,
            patchIsRound: true, // Dùng hình elip thay vì hình chữ nhật
            patchScaleW: 0.7,   // Tỉ lệ chiều rộng vá so với miệng
            patchScaleH: 0.5,   // Tỉ lệ chiều cao vá so với miệng
            patchOffsetY: 5     // Dịch miếng vá lên xuống
        };

        // --- CORE FUNCTIONS ---

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Draw Character
            if (assets.charLoaded) {
                // Fit image to canvas (contain)
                let ratio = Math.min(canvas.width / assets.char.width, canvas.height / assets.char.height);
                let w = assets.char.width * ratio;
                let h = assets.char.height * ratio;
                ctx.drawImage(assets.char, 0, 0, w, h);
            } else {
                ctx.fillStyle = "#95a5a6";
                ctx.textAlign = "center";
                ctx.font = "20px Arial";
                ctx.fillText("Hãy tải ảnh nhân vật và sprite miệng...", canvas.width/2, canvas.height/2);
            }

            if (!assets.mouthLoaded) return;

            // 2. Calculate Dimensions
            const frameW = assets.mouth.width / 4; // Giả định sprite có 4 hình
            const frameH = assets.mouth.height;
            
            const drawW = frameW * state.scale;
            const drawH = frameH * state.scale;

            // 3. Draw Skin Patch (Miếng vá)
            if (state.patchEnabled && assets.charLoaded) {
                ctx.fillStyle = state.patchColor;
                
                // Kích thước miếng vá (độc lập tương đối với miệng)
                const patchW = drawW * state.patchScaleW;
                const patchH = drawH * state.patchScaleH;
                const patchX = state.x + (drawW - patchW) / 2; // Căn giữa theo X
                const patchY = state.y + (drawH - patchH) / 2 + state.patchOffsetY; // Căn giữa theo Y + Offset

                ctx.beginPath();
                if (state.patchIsRound) {
                    // Vẽ hình Elip (Bầu dục) -> Tránh góc nhọn đâm vào cằm
                    ctx.ellipse(
                        patchX + patchW/2,  // Center X
                        patchY + patchH/2,  // Center Y
                        patchW/2,           // Radius X
                        patchH/2,           // Radius Y
                        0, 0, 2 * Math.PI
                    );
                } else {
                    // Vẽ hình chữ nhật (cũ)
                    ctx.rect(patchX, patchY, patchW, patchH);
                }
                ctx.fill();

                // Debug: Vẽ viền miếng vá khi không nói để dễ chỉnh
                if (!state.talking) {
                    ctx.strokeStyle = "rgba(255, 255, 0, 0.5)"; // Viền vàng mờ
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            // 4. Draw Mouth Sprite
            const sx = state.frameIndex * frameW;
            ctx.drawImage(
                assets.mouth,
                sx, 0, frameW, frameH,
                state.x, state.y, drawW, drawH
            );

            // Debug border for mouth
            if (!state.talking) {
                ctx.strokeStyle = "rgba(0, 255, 0, 0.3)";
                ctx.strokeRect(state.x, state.y, drawW, drawH);
            }
        }

        // --- ANIMATION LOOP ---
        function toggleTalk() {
            const btn = document.getElementById('btnTalk');
            if (state.talking) {
                clearInterval(state.timer);
                state.talking = false;
                state.frameIndex = 0; // Về trạng thái ngậm
                btn.innerText = "▶ BẮT ĐẦU NÓI";
                btn.classList.remove('stop');
                draw();
            } else {
                if (!assets.mouthLoaded) return alert("Thiếu ảnh miệng!");
                state.talking = true;
                btn.innerText = "⏹ DỪNG LẠI";
                btn.classList.add('stop');
                
                state.timer = setInterval(() => {
                    // Random mouth frame: 0 (closed), 1, 2, 3 (open)
                    // Logic: Ít khi đóng hẳn, chủ yếu mở để tạo cảm giác nói
                    let r = Math.random();
                    if (r > 0.85) state.frameIndex = 0;
                    else if (r > 0.6) state.frameIndex = 3;
                    else if (r > 0.3) state.frameIndex = 2;
                    else state.frameIndex = 1;
                    draw();
                }, state.speed);
            }
        }

        // --- EVENT HANDLERS ---

        // 1. Uploads
        document.getElementById('uploadChar').onchange = e => {
            const reader = new FileReader();
            reader.onload = evt => {
                assets.char.src = evt.target.result;
                assets.char.onload = () => { assets.charLoaded = true; draw(); }
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('uploadMouth').onchange = e => {
            const reader = new FileReader();
            reader.onload = evt => {
                assets.mouth.src = evt.target.result;
                assets.mouth.onload = () => { 
                    assets.mouthLoaded = true; 
                    state.x = canvas.width/2 - 50; 
                    state.y = canvas.height/2; 
                    draw(); 
                }
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        // 2. Color Picker (Click on Canvas)
        canvas.addEventListener('mousedown', e => {
            if (state.talking) return; // Không chỉnh khi đang nói
            
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            // Kiểm tra xem có đang click vào vùng miệng để kéo không
            const frameW = (assets.mouth.width / 4) * state.scale;
            const frameH = assets.mouth.height * state.scale;
            
            if (mouseX >= state.x && mouseX <= state.x + frameW &&
                mouseY >= state.y && mouseY <= state.y + frameH) {
                // Đang drag miệng
                canvas.onmousemove = moveE => {
                    state.x = moveE.clientX - rect.left - frameW/2;
                    state.y = moveE.clientY - rect.top - frameH/2;
                    draw();
                };
            } else if (assets.charLoaded) {
                // Đang pick màu da
                const pixel = ctx.getImageData(mouseX, mouseY, 1, 1).data;
                const hex = "#" + ((1 << 24) + (pixel[0] << 16) + (pixel[1] << 8) + pixel[2]).toString(16).slice(1);
                state.patchColor = hex;
                document.getElementById('hexValue').value = hex;
                document.getElementById('colorPreview').style.background = hex;
                draw();
            }
        });
        
        canvas.addEventListener('mouseup', () => canvas.onmousemove = null);
        canvas.addEventListener('mouseout', () => canvas.onmousemove = null);

        // 3. UI Controls Binding
        const bind = (id, key, type = 'value') => {
            document.getElementById(id).addEventListener('input', e => {
                let val = type === 'checkbox' ? e.target.checked : parseFloat(e.target.value);
                state[key] = val;
                if(id === 'scaleSlider') document.getElementById('valScale').innerText = val;
                draw();
            });
        };

        bind('scaleSlider', 'scale');
        bind('speedSlider', 'speed'); // Cập nhật tốc độ realtime cần restart interval, ở đây đơn giản chỉ lưu value
        bind('patchW', 'patchScaleW');
        bind('patchH', 'patchScaleH');
        bind('patchOffY', 'patchOffsetY');
        bind('chkShowPatch', 'patchEnabled', 'checkbox');
        bind('chkRoundPatch', 'patchIsRound', 'checkbox');

        // Restart speed logic
        document.getElementById('speedSlider').addEventListener('change', () => {
            if(state.talking) { toggleTalk(); toggleTalk(); } // Reset timer
        });

        // Scroll to zoom mouth (Tiện ích thêm)
        canvas.addEventListener('wheel', e => {
            e.preventDefault();
            state.scale += e.deltaY * -0.001;
            state.scale = Math.min(Math.max(.1, state.scale), 3);
            document.getElementById('scaleSlider').value = state.scale;
            document.getElementById('valScale').innerText = state.scale.toFixed(2);
            draw();
        });

        // Init
        draw();

    </script>
</body>
</html>