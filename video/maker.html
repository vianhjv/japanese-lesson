<!-- FILE: maker.html -->
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JLPT Video Studio (Admin)</title>
    <link rel="stylesheet" href="styles-video.css">
    <style>
        /* CSS ri√™ng cho ph·∫ßn Editor (Admin Only) */
        .toggle-btn { 
            position: absolute; top: 15px; right: 15px; z-index: 200; 
            padding: 10px 20px; border-radius: 30px; border: none; cursor: pointer; 
            background: rgba(0,0,0,0.8); color: white; font-weight: bold;
        }
        #editor {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8f9fa; z-index: 2000; transition: 0.4s;
            display: flex; flex-direction: column;
            transform: translateY(0); /* M·∫∑c ƒë·ªãnh hi·ªán editor */
        }
        #editor.hidden { transform: translateY(-100%); }
        .editor-content { flex: 1; overflow-y: auto; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; }
        .input-group { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        textarea { width: 100%; height: 150px; font-family: monospace; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .voice-map-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        select { width: 100%; padding: 8px; }
        .export-area { background: #333; color: #0f0; padding: 10px; font-family: monospace; border-radius: 5px; word-break: break-all; font-size: 12px; display: none;}
    </style>
</head>
<body>

    <!-- N√∫t b·∫≠t/t·∫Øt Editor -->
    <button class="toggle-btn" onclick="document.getElementById('editor').classList.toggle('hidden')">üõ† Toggle Editor</button>

    <!-- GIAO DI·ªÜN EDITOR -->
    <div id="editor">
        <div style="padding: 15px; background: white; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0;">üé• Studio Config</h2>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-save" onclick="previewLesson()">‚ñ∂ Preview (Load)</button>
                <button class="btn btn-scan" onclick="exportConfig()">üì§ Export Config</button>
            </div>
        </div>

        <div class="editor-content">
            <!-- 1. CH·ªåN B√ÄI H·ªåC -->
            <div class="input-group" style="background: #e3f2fd; border: 1px solid #2196f3;">
                <label>üìö <b>Ch·ªçn b√†i h·ªçc (Load t·ª´ data.js):</b></label>
                <select id="lessonSelect" onchange="loadLessonData(this.value)" style="margin-top: 5px; font-size: 16px; padding: 10px;">
                    <option value="">-- Ch·ªçn b√†i ƒë·ªÉ t·∫£i d·ªØ li·ªáu --</option>
                    <!-- Options s·∫Ω ƒë∆∞·ª£c JS ƒëi·ªÅn v√†o -->
                </select>
            </div>

            <div class="input-group">
                <label>üñº Link ·∫¢nh/Video n·ªÅn:</label>
                <input type="text" id="mediaInput" style="width: 100%; padding: 10px; margin-top: 5px;" value="">
            </div>

            <div class="input-group">
                <label>üìù K·ªãch b·∫£n:</label>
                <textarea id="txtInput"></textarea>
                <div style="margin-top: 10px;">
                    <button class="btn btn-scan" onclick="scanCharacters()">üîÑ Qu√©t Nh√¢n V·∫≠t</button>
                </div>
            </div>

            <div class="input-group">
                <label>üé≠ C·∫•u h√¨nh Gi·ªçng (S·∫Ω l∆∞u v√†o Export):</label>
                <div id="voiceMappingContainer" style="margin-top: 10px;"></div>
            </div>
            
            <div class="input-group">
                <label>üíæ M√£ JSON (Copy c√°i n√†y d√°n ƒë√® v√†o data.js n·∫øu c√≥ thay ƒë·ªïi gi·ªçng):</label>
                <div id="exportOutput" class="export-area"></div>
            </div>
        </div>
    </div>

    <!-- KHU V·ª∞C HI·ªÇN TH·ªä (PLAYER) -->
    <div class="media-stage">
        <img id="bgImg" class="media-content" src="" style="display:none;">
        <video id="bgVid" class="media-content" src="" style="display:none;" loop playsinline muted></video>
    </div>

    <div class="script-stage">
        <div id="scriptContent" class="script-content"></div>
    </div>

    <div class="controls">
        <button class="btn" onclick="playAll('jp')">üáØüáµ Japanese</button>
        <button class="btn" onclick="playAll('vn')">üáªüá≥ Vietnamese</button>
        <button class="btn" id="btnPause" onclick="togglePause()">‚è∏ Pause</button>
        <button class="btn" onclick="stopPlayer()">‚èπ Stop</button>
    </div>

    <!-- LOAD C√ÅC FILE JS -->
    <script src="data.js"></script>
    <script src="script-video.js"></script>
    <script>
        // --- LOGIC RI√äNG C·ª¶A TRANG MAKER ---
        // --- C·∫§U H√åNH ∆ØU TI√äN GI·ªåNG (PRESETS) ---
        // T·∫°i ƒë√¢y b·∫°n ƒë·ªãnh nghƒ©a gi·ªçng mong mu·ªën cho t·ª´ng nh√¢n v·∫≠t.
        // H·ªá th·ªëng s·∫Ω t√¨m trong t√™n gi·ªçng c√≥ ch·ª©a t·ª´ kh√≥a n√†y kh√¥ng.
        const PREFERRED_MAPPING = {
            "An":       { jp: "Nanami", vn: "HoaiMy" },
            "Tanaka":   { jp: "Keita",  vn: "NamMinh" },
            "Suzuki":   { jp: "Ayumi",  vn: "HoaiMy" }, // Suzuki d√πng chung gi·ªçng Vi·ªát v·ªõi An
            "Yamada":   { jp: "Ichiro", vn: "NamMinh" }, // Gi·∫£ s·ª≠ Yamada d√πng gi·ªçng Nam Minh
            "Narrator": { jp: "Sayaka", vn: "HoaiMy" }   // Ng∆∞·ªùi d·∫´n chuy·ªán
        };

        // --- LOGIC RI√äNG C·ª¶A TRANG MAKER (PHI√äN B·∫¢N T·ª∞ ƒê·ªòNG H√ìA) ---
        
        let currentLessonId = "";

        // 1. Kh·ªüi t·∫°o
        window.onload = async function() {
            if (typeof lessonData === 'undefined') {
                alert("L·ªñI: Kh√¥ng t√¨m th·∫•y file data.js!");
                return;
            }
            await voiceManager.init(); // ƒê·ª£i load gi·ªçng t·ª´ tr√¨nh duy·ªát
            populateLessonSelect();
        };

        function populateLessonSelect() {
            const sel = document.getElementById('lessonSelect');
            sel.innerHTML = '<option value="">-- Ch·ªçn b√†i ƒë·ªÉ t·∫£i d·ªØ li·ªáu --</option>';
            lessonData.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.id;
                opt.textContent = l.title;
                sel.appendChild(opt);
            });
        }

        // 2. Load d·ªØ li·ªáu khi ch·ªçn b√†i
        function loadLessonData(id) {
            if(!id) return;
            const lesson = lessonData.find(l => l.id === id);
            if(!lesson) return;

            currentLessonId = id;
            if (!lesson.voiceConfig) lesson.voiceConfig = {};

            document.getElementById('mediaInput').value = lesson.mediaUrl;
            document.getElementById('txtInput').value = lesson.script;
            
            scanCharacters(); // T·ª± ƒë·ªông qu√©t v√† ƒëi·ªÅn gi·ªçng
        }

        // 3. Qu√©t nh√¢n v·∫≠t & T·ª∞ ƒê·ªòNG G√ÅN GI·ªåNG (AUTO-FILL)
        function scanCharacters() {
            const raw = document.getElementById('txtInput').value;
            const currentLesson = lessonData.find(l => l.id === currentLessonId);
            if (!currentLesson) return;

            const lines = raw.split('\n').filter(l => l.trim());
            const charSet = new Set();
            lines.forEach(line => { if(line.includes(':')) charSet.add(line.split(':')[0].trim()); });

            const container = document.getElementById('voiceMappingContainer');
            container.innerHTML = '';

            charSet.forEach(char => {
                const row = document.createElement('div'); row.className = 'voice-map-row';
                const label = document.createElement('div'); label.textContent = char; label.style.fontWeight = 'bold';
                
                // H√†m t·∫°o Dropdown ch·ªçn gi·ªçng
                const createSel = (voices, type) => {
                    const sel = document.createElement('select');
                    
                    // Option m·∫∑c ƒë·ªãnh
                    const defOpt = document.createElement('option');
                    defOpt.value = ""; defOpt.textContent = "M·∫∑c ƒë·ªãnh (Default)";
                    sel.appendChild(defOpt);

                    // T√¨m gi·ªçng ∆∞u ti√™n trong danh s√°ch (D·ª±a tr√™n t√™n nh√¢n v·∫≠t)
                    let preferredVoiceURI = "";
                    if (PREFERRED_MAPPING[char] && PREFERRED_MAPPING[char][type]) {
                        const keyword = PREFERRED_MAPPING[char][type].toLowerCase();
                        // T√¨m gi·ªçng n√†o c√≥ t√™n ch·ª©a t·ª´ kh√≥a (VD: t√¨m gi·ªçng c√≥ ch·ªØ "Nanami")
                        const found = voices.find(v => v.name.toLowerCase().includes(keyword));
                        if (found) preferredVoiceURI = found.voiceURI;
                    }

                    voices.forEach(v => {
                        const opt = document.createElement('option');
                        opt.value = v.voiceURI; opt.textContent = v.name;
                        sel.appendChild(opt);
                    });
                    
                    // --- LOGIC CH·ªåN GI·ªåNG ---
                    // ∆Øu ti√™n 1: ƒê√£ l∆∞u trong b√†i h·ªçc t·ª´ tr∆∞·ªõc
                    if(currentLesson.voiceConfig[char] && currentLesson.voiceConfig[char][type]) {
                        sel.value = currentLesson.voiceConfig[char][type];
                    }
                    // ∆Øu ti√™n 2: N·∫øu ch∆∞a l∆∞u, th√¨ T·ª∞ CH·ªåN theo c·∫•u h√¨nh ∆∞u ti√™n
                    else if (preferredVoiceURI) {
                        sel.value = preferredVoiceURI;
                        // L∆∞u lu√¥n v√†o RAM ƒë·ªÉ ƒë·ª° ph·∫£i ch·ªçn l·∫°i
                        if(!currentLesson.voiceConfig[char]) currentLesson.voiceConfig[char] = {};
                        currentLesson.voiceConfig[char][type] = preferredVoiceURI;
                    }

                    // S·ª± ki·ªán khi ng∆∞·ªùi d√πng thay ƒë·ªïi th·ªß c√¥ng
                    sel.onchange = () => {
                        if(!currentLesson.voiceConfig[char]) currentLesson.voiceConfig[char] = {};
                        currentLesson.voiceConfig[char][type] = sel.value;
                    };
                    return sel;
                };

                row.appendChild(label);
                row.appendChild(createSel(voiceManager.jpVoices, 'jp'));
                row.appendChild(createSel(voiceManager.vnVoices, 'vn'));
                container.appendChild(row);
            });
        }

        // 4. Preview
        function previewLesson() {
            const raw = document.getElementById('txtInput').value;
            const mediaUrl = document.getElementById('mediaInput').value;
            
            const img = document.getElementById('bgImg');
            const vid = document.getElementById('bgVid');
            if(mediaUrl && mediaUrl.match(/\.(mp4|webm)$/i)) {
                vid.src = mediaUrl; vid.style.display='block'; img.style.display='none'; vid.play();
            } else {
                img.src = mediaUrl || ''; img.style.display='block'; vid.style.display='none';
            }

            const container = document.getElementById('scriptContent');
            container.innerHTML = '';
            const scriptLines = [];
            const lines = raw.split('\n').filter(l => l.trim());
            
            let lastChar = ''; let isLeft = true;
            lines.forEach((line, idx) => {
                const firstColon = line.indexOf(':');
                if(firstColon === -1) return;
                const charName = line.substring(0, firstColon).trim();
                const content = line.substring(firstColon + 1);
                const parts = content.split('|');
                if(lastChar && charName !== lastChar) isLeft = !isLeft;
                lastChar = charName;
                const div = document.createElement('div');
                div.className = `row ${isLeft ? 'left' : 'right'} t${(idx % 3) + 1}`;
                div.id = `line-${idx}`;
                div.innerHTML = `
                    <div class="avatar">${charName.charAt(0)}</div>
                    <div class="bubble">
                        <div class="japanese-text" id="jp-text-${idx}">${parts[0].trim()}</div>
                        ${parts[1] ? `<span class="vietnamese-text" id="vn-text-${idx}">${parts[1].trim()}</span>` : ''}
                    </div>
                `;
                div.onclick = () => {
                     stopPlayer();
                     playerState.currentIndex = idx;
                     playerState.isPlaying = true;
                     speakNext();
                };
                container.appendChild(div);
                scriptLines.push({ index: idx, char: charName, jpId: `jp-text-${idx}`, vnId: `vn-text-${idx}`, rowId: `line-${idx}` });
            });

            const currentLesson = lessonData.find(l => l.id === currentLessonId);
            initPlayer(scriptLines, currentLesson ? currentLesson.voiceConfig : {});
            document.getElementById('editor').classList.add('hidden');
        }

        // 5. Xu·∫•t Config
        function exportConfig() {
            const exportBox = document.getElementById('exportOutput');
            exportBox.style.display = 'block';
            const jsonStr = JSON.stringify(lessonData, null, 4);
            exportBox.textContent = "/* Copy to√†n b·ªô v√† d√°n ƒë√® v√†o data.js */\nconst lessonData = " + jsonStr + ";";
            exportBox.scrollIntoView({behavior: "smooth"});
            alert("ƒê√£ xu·∫•t c·∫•u h√¨nh! H√£y copy v√† c·∫≠p nh·∫≠t file data.js");
        }
  




    </script>
</body>
</html>
