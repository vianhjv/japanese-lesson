<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªçc ti·∫øng Nh·∫≠t c√πng An : Nghe, n√≥i kaiwa</title>
    
<style>
        /* --- Thi·∫øt l·∫≠p c∆° b·∫£n --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6; margin: 0;  background-color: #f3eadc; 
           }
        .page-header, .page-footer { text-align: center; padding: 20px; }

        /* --- C·∫•u tr√∫c khung c·∫£nh --- */
        .scene-container {
            max-width: 900px;
            margin: 20px auto;
            position: relative; /* ƒê·ªÉ canh ch·ªânh overlay */
        }

        .scene-background-image {
            display: block; 
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* CSS RESPONSIVE */
        .dialogue-overlay {
            position: relative; 
            z-index: 10;
            /* ƒêi·ªÅu ch·ªânh margin √¢m ƒë·ªÉ ƒë√® l√™n ·∫£nh m·ªôt c√°ch h·ª£p l√Ω */
            margin-top: -80px; 
            margin-left: 20px;
            margin-right: 20px;
            padding: 25px;
         background: rgba(200, 180, 140, 0.55); /* N·ªÅn s√°ng h∆°n, √≠t trong su·ªët h∆°n ƒë·ªÉ d·ªÖ ƒë·ªçc */
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.58);
           
        }
        
        @media (max-width: 600px) {
            .dialogue-overlay {
                margin-top: -40px; /* √çt ƒë√® l√™n h∆°n tr√™n mobile */
                margin-left: 10px;
                margin-right: 10px;
                padding: 15px;
            }
        }

        .dialogue-display-window {
            color: #333;
            text-align: left;
            min-height: 100px; /* ƒê·∫£m b·∫£o khung kh√¥ng b·ªã nh·∫£y khi ƒë·ªïi n·ªôi dung d√†i ng·∫Øn */
            display: flex;
            flex-direction: column;
        }
        
        /* Style cho c√°c th√†nh ph·∫ßn n·ªôi dung h·ªôi tho·∫°i */
        .speaker-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            
        }

        .speaker { font-weight: 800; font-size: 1.1rem; margin-right: 10px;}
        /* M√†u s·∫Øc ƒë·∫°i di·ªán cho nh√¢n v·∫≠t */
        .speaker.suzuki { color: #e67e22; } /* Cam */
        .speaker.tanaka { color: #2980b9; } /* Xanh d∆∞∆°ng */
        .speaker.an { color: #e84393; } /* H·ªìng ƒë·∫≠m */
        
        .dialogue-content-wrapper {
            display: flex;
            align-items: flex-start; /* CƒÉn h√†ng tr√™n c√πng */
            gap: 15px;
        }

        .dialogue-play-btn { 
            background-color: #228B22; /* N√∫t m√†u xanh l√° ch·ªß ƒë·∫°o */
            border: none; 
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 1.2rem; cursor: pointer; 
            color: white; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .dialogue-play-btn:hover { background-color: #1e7a1e; transform: scale(1.05); }
        .dialogue-play-btn:active { transform: scale(0.95); }

        .dialogue-texts { flex-grow: 1; }
        
        .japanese-text {
           font-size: clamp(1.2rem, 4vw, 1.6rem); /* TƒÉng k√≠ch th∆∞·ªõc font ti·∫øng Nh·∫≠t */
            line-height: 1.8;
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-weight: 500;
        }
        
        /* T·ªëi ∆∞u Furigana */
        ruby { ruby-align: center;}
        rt { font-size: 0.6em; color: #7f8c8d; user-select: none; } 

        .vietnamese-text {
            font-size: 1rem;
            color: #555; 
            margin-top: 0;
            font-style: normal;
            border-left: 3px solid #228B22;
            padding-left: 10px;
        }

        /* Highlight khi ƒë·ªçc */
        .highlight-word {  
            background-color: #fffa90; 
            border-radius: 4px; 
            box-shadow: 0 0 0 1px #f1c40f; /* Vi·ªÅn nh·∫π */
        }

        /* Ng·ªØ ph√°p n·ªïi b·∫≠t */
        .grammar-point {
            color: #c0392b; 
            font-weight: bold;
            border-bottom: 2px dotted #c0392b; /* G·∫°ch ch√¢n ch·∫•m bi */
        }

        /* B·∫£ng ƒëi·ªÅu khi·ªÉn */
        .dialogue-nav { 
            display: flex; justify-content: center; align-items: center; gap: 20px;
            margin-top: 20px; padding-top: 15px;
        }
        #counter { color: #777; font-weight: 500; min-width: 50px; text-align: center; }
        
        .nav-btn { 
            background-color: white; border: 1px solid #ccc; color: #333; 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; 
            font-weight: 500; display: flex; align-items: center; gap: 5px;
        }
        .nav-btn:hover:not(:disabled) { background-color: #f9f9f9; border-color: #999; }
        .nav-btn:disabled { opacity: 0.5; cursor: default; background-color: #f0f0f0; border-color: #ddd;}

    </style>
</head>
<body>

    <div class="page-header">
        <h2>N√≥i Kaiwa c√πng An</h2>
        <p>Luy·ªán Nghe, N√≥i, Ng·ªØ ph√°p, T·ª´ v·ª±ng thi JLPT</p>
    </div>

    <div class="scene-container">
        <img src="lesson1-chat.jpg" alt="Minh h·ªça h·ªôi tho·∫°i" class="scene-background-image">

        <div class="dialogue-overlay">
            
            <!-- Khung hi·ªÉn th·ªã -->
            <div class="dialogue-display-window"></div>

            <!-- Ngu·ªìn d·ªØ li·ªáu (·∫®n) -->
            <div class="dialogue-source" style="display: none;">
                
                <!-- Line 1 -->
                <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker suzuki" data-character="suzuki">Èà¥Êú® (Suzuki)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">üîä</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text"><ruby>Áî∞‰∏≠<rt>„Åü„Å™„Åã</rt></ruby>„Åï„Çì„ÄÅ<ruby>ÈÄ±Êú´<rt>„Åó„ÇÖ„ÅÜ„Åæ„Å§</rt></ruby>„ÅØ<ruby>‰Ωï<rt>„Å™„Å´</rt></ruby>„Çí„Åô„Çã„ÅÆÔºü</p>
                            <p class="vietnamese-text">Anh Tanaka, cu·ªëi tu·∫ßn anh l√†m g√¨ th·∫ø?</p>
                        </div>
                    </div>
                </div>

                <!-- Line 2 -->
                <div class="dialogue-line">
                    <div class="speaker-container">
                        <!-- T√¥i g√°n Tanaka d√πng gi·ªçng Keita n·∫øu c√≥, ho·∫∑c Ichiro -->
                        <span class="speaker tanaka" data-character="tanaka">Áî∞‰∏≠ (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">üîä</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">„ÅÜ„Éº„Çì„ÄÅ„Åæ„Å†<ruby>Ê±∫<rt>„Åç</rt></ruby>„ÇÅ„Å¶„Å™„ÅÑ„Åë„Å©„ÄÅ<ruby>ÂÆ∂<rt>„ÅÑ„Åà</rt></ruby>„Åß<ruby>Êú¨<rt>„Åª„Çì</rt></ruby>„Çí <span class="grammar-point"><ruby>Ë™≠<rt>„Çà</rt></ruby>„Çì„Åß</span>„ÄÅ<ruby>Èü≥Ê•Ω<rt>„Åä„Çì„Åå„Åè</rt></ruby>„Çí <span class="grammar-point"><ruby>ËÅû<rt>„Åç</rt></ruby>„ÅÑ„Å¶</span>„ÄÅ„ÇÜ„Å£„Åè„Çä„Åô„Çã„Åã„Å™„ÄÇ</p>
                            <p class="vietnamese-text">·ª™m, t√¥i ch∆∞a quy·∫øt ƒë·ªãnh n·ªØa, nh∆∞ng ch·∫Øc l√† s·∫Ω ƒë·ªçc s√°ch, nghe nh·∫°c ·ªü nh√† v√† th∆∞ gi√£n th√¥i.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 3 -->
                <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker suzuki" data-character="suzuki">Èà¥Êú® (Suzuki)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">üîä</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text"><ruby>ÁßÅ<rt>„Çè„Åü„Åó</rt></ruby>„ÅØ<ruby>ÂèãÈÅî<rt>„Å®„ÇÇ„Å†„Å°</rt></ruby>„Å´ <span class="grammar-point"><ruby>‰ºö<rt>„ÅÇ</rt></ruby>„Å£„Å¶</span>„ÄÅ<ruby>‰∏ÄÁ∑í<rt>„ÅÑ„Å£„Åó„Çá</rt></ruby>„Å´„Åî<ruby>È£Ø<rt>„ÅØ„Çì</rt></ruby>„Çí <span class="grammar-point"><ruby>È£ü<rt>„Åü</rt></ruby>„Åπ„Çã</span>„Å§„ÇÇ„Çä„ÄÇ„Ç¢„É≥„Åï„Çì„ÅØÔºü</p>
                            <p class="vietnamese-text">Hay nh·ªâ. T√¥i th√¨ ƒë·ªãnh g·∫∑p b·∫°n r·ªìi c√πng nhau ƒÉn c∆°m. C√≤n An th√¨ sao?</p>
                        </div>
                    </div>
                </div>

                <!-- Line 4 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">„Ç¢„É≥ (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">üîä</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text"><ruby>ÁßÅ<rt>„Çè„Åü„Åó</rt></ruby>„ÅØ<ruby>Êó•Êú¨Ë™û<rt>„Å´„Åª„Çì„Åî</rt></ruby>„Çí<span class="grammar-point"><ruby>ÂãâÂº∑<rt>„Åπ„Çì„Åç„Çá„ÅÜ</rt></ruby>„Åó„Åæ„Åô</span>ÔºÅ„Åß„ÇÇ...„Äå<span class="grammar-point"><ruby>Ë™≠<rt>„Çà</rt></ruby>„Çì„Åß</span>„Äç„ÄÅ„Äå<span class="grammar-point"><ruby>ËÅû<rt>„Åç</rt></ruby>„ÅÑ„Å¶</span>„Äç„ÄÅ„Äå<span class="grammar-point"><ruby>‰ºö<rt>„ÅÇ</rt></ruby>„Å£„Å¶</span>„Äç...<ruby>ÂãïË©û<rt>„Å©„ÅÜ„Åó</rt></ruby>„ÅØ<ruby>Èù¢ÁôΩ<rt>„Åä„ÇÇ„Åó„Çç</rt></ruby>„ÅÑ„Åß„Åô„Åå„ÄÅ<ruby>Â∞ë<rt>„Åô„Åì</rt></ruby>„Åó<ruby>Ê∑∑‰π±<rt>„Åì„Çì„Çâ„Çì</rt></ruby>„Åó„Åæ„Åô„ÄÇ</p>
                            <p class="vietnamese-text">Em s·∫Ω h·ªçc ti·∫øng Nh·∫≠t ·∫°! Nh∆∞ng m√†... "yonde", "kiite", "atte"... ƒë·ªông t·ª´ th√∫ v·ªã th·∫≠t nh∆∞ng em h∆°i b·ªã r·ªëi.</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- ƒêi·ªÅu h∆∞·ªõng -->
            <div class="dialogue-nav">
                <button id="prevBtn" class="nav-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                    L√πi
                </button>
                <span id="counter">1 / 4</span>
                <button id="nextBtn" class="nav-btn">
                    Ti·∫øp
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="page-footer">
        <p>Ph·∫ßn n·ªôi dung ti·∫øp theo c·ªßa b√†i h·ªçc...</p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================
    // === PH·∫¶N 0: B·ªò QU·∫¢N L√ù GI·ªåNG ƒê·ªåC (N√ÇNG C·∫§P ∆ØU TI√äN MICROSOFT) ===
    // =================================================================
    const voiceManager = {
        characterMap: {},
        defaultVoice: null,
        voicesLoaded: false,

        // C·∫•u h√¨nh gi·ªçng ∆∞u ti√™n (keyword ƒë·ªÉ t√¨m trong t√™n gi·ªçng)
        preferences: {
            'an': 'nanami',      // ∆Øu ti√™n Nanami cho An
            'suzuki': 'haruka',  // ∆Øu ti√™n Haruka cho Suzuki
            'mio': 'haruka',     // ∆Øu ti√™n Haruka cho Mio
            'sato': 'sayaka',    // ∆Øu ti√™n Sayaka cho Sato-sensei
            'yamada': 'daichi',  // ∆Øu ti√™n Daichi cho Yamada-bucho
            'tanaka': 'keita'    // ∆Øu ti√™n Keita (ho·∫∑c Ichiro) cho Tanaka
        },

        init: function() {
            // Th·ª≠ t·∫£i gi·ªçng ngay l·∫≠p t·ª©c
            this.loadVoices();
            
            // Chrome/Edge c·∫ßn s·ª± ki·ªán n√†y ƒë·ªÉ t·∫£i danh s√°ch gi·ªçng ƒë·∫ßy ƒë·ªß
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => this.loadVoices();
            }
        },

        loadVoices: function() {
            if (this.voicesLoaded) return; // Tr√°nh ch·∫°y l·∫°i nhi·ªÅu l·∫ßn kh√¥ng c·∫ßn thi·∫øt

            const allVoices = speechSynthesis.getVoices();
            if (allVoices.length === 0) return; // Ch∆∞a c√≥ gi·ªçng n√†o

            // L·ªçc gi·ªçng ti·∫øng Nh·∫≠t
            const japaneseVoices = allVoices.filter(v => v.lang === 'ja-JP' || v.lang === 'ja_JP');

            if (japaneseVoices.length === 0) {
                console.warn("Kh√¥ng t√¨m th·∫•y gi·ªçng ti·∫øng Nh·∫≠t.");
                this.voicesLoaded = true;
                return;
            }

            this.defaultVoice = japaneseVoices[0];

            // 1. T√¨m c√°c gi·ªçng C·ª§ TH·ªÇ theo y√™u c·∫ßu (Microsoft voices)
            const foundPrefVoices = {};
            japaneseVoices.forEach(voice => {
                const voiceNameLower = voice.name.toLowerCase();
                // Ki·ªÉm tra xem gi·ªçng n√†y c√≥ kh·ªõp v·ªõi t·ª´ kh√≥a ∆∞u ti√™n n√†o kh√¥ng
                for (const [prefKey, prefKeyword] of Object.entries(this.preferences)) {
                    if (voiceNameLower.includes(prefKeyword)) {
                        foundPrefVoices[prefKeyword] = voice;
                    }
                }
            });

            console.log("T√¨m th·∫•y c√°c gi·ªçng ∆∞u ti√™n:", Object.keys(foundPrefVoices));

            // 2. T·∫°o danh s√°ch d·ª± ph√≤ng (Fallback) ph√¢n lo·∫°i Nam/N·ªØ chung chung
            // S·ª≠ d·ª•ng regex ƒë·ªÉ ƒëo√°n gi·ªõi t√≠nh qua t√™n ph·ªï bi·∫øn
            const femaleGenerics = japaneseVoices.filter(v => /nanami|haruka|sayaka|ayumi|kyoko|mio/i.test(v.name));
            const maleGenerics = japaneseVoices.filter(v => /ichiro|keita|otoya|kenji|daisuke/i.test(v.name));

            // H√†m tr·ª£ gi√∫p ƒë·ªÉ l·∫•y gi·ªçng: ∆Øu ti√™n -> D·ª± ph√≤ng theo gi·ªõi t√≠nh -> M·∫∑c ƒë·ªãnh
            const assignVoice = (charId, genderList, fallbackIndex) => {
                const prefKeyword = this.preferences[charId];
                // T·∫ßng 1: N·∫øu c√≥ gi·ªçng ∆∞u ti√™n c·ª• th·ªÉ
                if (foundPrefVoices[prefKeyword]) {
                    return foundPrefVoices[prefKeyword];
                }
                // T·∫ßng 2: D√πng danh s√°ch d·ª± ph√≤ng theo gi·ªõi t√≠nh
                if (genderList.length > 0) {
                    return genderList[fallbackIndex % genderList.length];
                }
                // T·∫ßng 3: Gi·ªçng m·∫∑c ƒë·ªãnh
                return this.defaultVoice;
            };

            // 3. Th·ª±c hi·ªán g√°n gi·ªçng cu·ªëi c√πng
            this.characterMap = {
                'an': assignVoice('an', femaleGenerics, 0),
                'suzuki': assignVoice('suzuki', femaleGenerics, 1),
                'sato': assignVoice('sato', femaleGenerics, 2),
                'mio': assignVoice('mio', femaleGenerics, 1), // D√πng chung logic d·ª± ph√≤ng v·ªõi Suzuki
                'yamada': assignVoice('yamada', maleGenerics, 0),
                'tanaka': assignVoice('tanaka', maleGenerics, 1),
            };

            console.log("B·∫£n ƒë·ªì gi·ªçng ƒë·ªçc cu·ªëi c√πng:", 
                Object.fromEntries(Object.entries(this.characterMap).map(([k, v]) => [k, v.name]))
            );
            
            this.voicesLoaded = true;
            
            // N·∫øu ƒëang ·ªü slide ƒë·∫ßu ti√™n, t·∫£i l·∫°i ƒë·ªÉ √°p d·ª•ng gi·ªçng (ph√≤ng tr∆∞·ªùng h·ª£p voices load ch·∫≠m)
            if (typeof activateSpeechForCurrentLine === 'function') {
                activateSpeechForCurrentLine();
            }
        },

        getVoiceFor: function(characterName) {
            if (!this.voicesLoaded) this.loadVoices(); // C·ªë g·∫Øng t·∫£i l·∫°i n·∫øu ch∆∞a c√≥
            return this.characterMap[characterName] || this.defaultVoice;
        }
    };

    voiceManager.init();


    // =================================================================
    // === PH·∫¶N 1: B·ªò M√ÅY ƒê·ªåC V√Ä HIGHLIGHT (Gi·ªØ nguy√™n logic t·ªët)    ===
    // =================================================================
    let currentSpeechHandler = null;
    
    function createSpeechHandler(targetElement, characterName) {
        // L∆∞u HTML g·ªëc (bao g·ªìm th·∫ª ruby/rt)
        let originalHTML = targetElement.innerHTML;
        let charMap = []; 
        let plainText = '';
        let utterance = null;
        let isPlaying = false;
        let isPaused = false;

        // H√†m chu·∫©n b·ªã: T√°ch t·ª´ng k√Ω t·ª± ƒë·ªÉ highlight, nh∆∞ng gi·ªØ nguy√™n c·∫•u tr√∫c Ruby
        function _prepareForSpeech() {
            plainText = '';
            charMap = [];
            
            // T·∫°o b·∫£n sao ƒë·ªÉ thao t√°c, tr√°nh ·∫£nh h∆∞·ªüng DOM hi·ªán t·∫°i ngay l·∫≠p t·ª©c
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalHTML;

            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    plainText += text;
                    const fragment = document.createDocumentFragment();
                    for (const char of text) {
                        const span = document.createElement('span');
                        span.textContent = char;
                        fragment.appendChild(span);
                        charMap.push(span); // L∆∞u tham chi·∫øu span v√†o m·∫£ng
                    }
                    node.parentNode.replaceChild(fragment, node);
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // B·ªè qua n·ªôi dung trong th·∫ª <rt> (furigana) khi l·∫•y plainText ƒë·ªçc
                    if (node.tagName === 'RT') return;
                    
                    // Duy·ªát ƒë·ªá quy c√°c node con (chuy·ªÉn th√†nh m·∫£ng ƒë·ªÉ tr√°nh l·ªói live collection)
                    Array.from(node.childNodes).forEach(processNode);
                }
            }

            processNode(tempDiv);
            // C·∫≠p nh·∫≠t l·∫°i DOM th·∫≠t v·ªõi c√°c th·∫ª span ƒë√£ b·ªçc
            targetElement.innerHTML = tempDiv.innerHTML;
            
            // C·∫≠p nh·∫≠t l·∫°i tham chi·∫øu charMap t·ªõi c√°c span th·ª±c t·∫ø trong DOM m·ªõi
            const allSpans = targetElement.querySelectorAll('span:not(.grammar-point)');
            let spanIndex = 0;
            // Logic n√†y h∆°i ph·ª©c t·∫°p ƒë·ªÉ map l·∫°i span trong tempDiv v·ªõi DOM th·∫≠t
            // C√°ch ƒë∆°n gi·∫£n h∆°n l√† clear charMap v√† t√¨m l·∫°i span kh√¥ng c√≥ class
            charMap = Array.from(targetElement.querySelectorAll('span')).filter(s => !s.classList.contains('grammar-point'));
        }

        function _cleanup() {
            // Kh√¥i ph·ª•c HTML g·ªëc (x√≥a c√°c th·∫ª span highlight)
            targetElement.innerHTML = originalHTML;
            isPlaying = false;
            isPaused = false;
            const btn = displayWindow.querySelector('.dialogue-play-btn');
            if(btn) btn.innerHTML = 'üîä'; // Reset icon
        }

        function play() {
            // D·ª´ng audio kh√°c ƒëang ch·∫°y
            if (currentSpeechHandler && currentSpeechHandler !== this) {
                currentSpeechHandler.stop();
            }
            currentSpeechHandler = this;
            const btn = displayWindow.querySelector('.dialogue-play-btn');

            // X·ª≠ l√Ω Resume
            if (isPlaying && isPaused) {
                speechSynthesis.resume();
                isPaused = false;
                if(btn) btn.innerHTML = '‚è∏';
                return;
            }
            
            // X·ª≠ l√Ω Pause
            if (isPlaying && !isPaused) {
                speechSynthesis.pause();
                isPaused = true;
                if(btn) btn.innerHTML = '‚ñ∂';
                return;
            }
            
            // B·∫Øt ƒë·∫ßu ƒë·ªçc m·ªõi
            speechSynthesis.cancel(); // H·ªßy c√°c h√†ng ƒë·ª£i c≈©
            
            // Chu·∫©n b·ªã DOM (b·ªçc span)
            _prepareForSpeech();
            isPlaying = true;
            isPaused = false;
            if(btn) btn.innerHTML = '‚è∏';
            
            utterance = new SpeechSynthesisUtterance(plainText);
            utterance.lang = 'ja-JP';
            utterance.rate = 1; // ƒê·ªçc ch·∫≠m h∆°n m·ªôt ch√∫t cho ng∆∞·ªùi h·ªçc (t√πy ch·ªçn)

            // L·∫•y gi·ªçng t·ª´ voiceManager
            const assignedVoice = voiceManager.getVoiceFor(characterName);
            if (assignedVoice) {
                utterance.voice = assignedVoice;
            }

            utterance.onboundary = (event) => {
                if (event.name !== 'word') return;
                
                // X√≥a highlight c≈©
                const highlighted = targetElement.querySelectorAll('.highlight-word');
                highlighted.forEach(el => el.classList.remove('highlight-word'));

                // Highlight t·ª´ m·ªõi
                for (let i = 0; i < event.charLength; i++) {
                    const charIndex = event.charIndex + i;
                    if (charMap[charIndex]) {
                        charMap[charIndex].classList.add('highlight-word');
                    }
                }
            };

            utterance.onend = () => {
                _cleanup();
                currentSpeechHandler = null;
            };
            
            utterance.onerror = (event) => {
                console.error('L·ªói ƒë·ªçc:', event);
                _cleanup();
                currentSpeechHandler = null;
            };
            
            speechSynthesis.speak(utterance);
        }

        function stop() {
            if(isPlaying || isPaused) {
                speechSynthesis.cancel();
                _cleanup();
                currentSpeechHandler = null;
            }
        }

        return { play, stop, get isPlaying() { return isPlaying; } };
    }

    // =================================================================
    // === PH·∫¶N 2: ƒêI·ªÄU KHI·ªÇN H·ªòI THO·∫†I (SLIDESHOW)                  ===
    // =================================================================
    const displayWindow = document.querySelector('.dialogue-display-window');
    const sourceLines = document.querySelectorAll('.dialogue-source .dialogue-line');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const counter = document.getElementById('counter');
    
    let currentIndex = 0;
    const totalLines = sourceLines.length;
    let currentLineHandler = null;

    // ƒê∆∞a h√†m n√†y ra scope ngo√†i ƒë·ªÉ voiceManager c√≥ th·ªÉ g·ªçi khi load xong gi·ªçng
    window.activateSpeechForCurrentLine = function() {
        if (currentLineHandler) {
            currentLineHandler.stop();
        }
        
        const currentPlayBtn = displayWindow.querySelector('.dialogue-play-btn');
        const currentTextElement = displayWindow.querySelector('.japanese-text');
        const currentSpeakerElement = displayWindow.querySelector('.speaker');

        if (currentPlayBtn && currentTextElement && currentSpeakerElement) {
            const characterName = currentSpeakerElement.dataset.character;
            currentLineHandler = createSpeechHandler(currentTextElement, characterName);
            
            // X√≥a event listener c≈© (b·∫±ng c√°ch clone n√∫t) ƒë·ªÉ tr√°nh double click
            const newBtn = currentPlayBtn.cloneNode(true);
            currentPlayBtn.parentNode.replaceChild(newBtn, currentPlayBtn);
            
            newBtn.addEventListener('click', () => {
                currentLineHandler.play();
            });
        }
    }

    function showLine(index) {
        if (index >= 0 && index < totalLines) {
            // Fade out nh·∫π (t√πy ch·ªçn, n·∫øu mu·ªën m∆∞·ª£t h∆°n)
            displayWindow.style.opacity = 0;
            
            setTimeout(() => {
                if (currentLineHandler) currentLineHandler.stop();
                displayWindow.innerHTML = sourceLines[index].innerHTML;
                window.activateSpeechForCurrentLine(); 
                counter.textContent = `${index + 1} / ${totalLines}`;
                
                updateNavButtons();
                displayWindow.style.opacity = 1; // Fade in
            }, 150); // Th·ªùi gian kh·ªõp v·ªõi transition CSS
        }
    }
    
    // Th√™m transition cho opacity v√†o CSS c·ªßa .dialogue-display-window
    displayWindow.style.transition = 'opacity 0.15s ease';

    function updateNavButtons() {
        prevBtn.disabled = (currentIndex === 0);
        nextBtn.disabled = (currentIndex === totalLines - 1);
    }

    nextBtn.addEventListener('click', () => {
        if (currentIndex < totalLines - 1) {
            currentIndex++;
            showLine(currentIndex);
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            showLine(currentIndex);
        }
    });

    // Kh·ªüi ch·∫°y
    if (totalLines > 0) {
        showLine(0);
    }
});
</script>
</body>
</html>
