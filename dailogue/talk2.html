<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài 2: Thể て & Thể た | Học tiếng Nhật cùng An</title>
    
<style>
        /* --- Thiết lập cơ bản --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6; margin: 0;  background-color: #f3eadc; 
           }
        .page-header, .page-footer { text-align: center; padding: 20px; }

        /* --- Cấu trúc khung cảnh --- */
        .scene-container {
            max-width: 900px;
            margin: 20px auto;
            position: relative; /* Để canh chỉnh overlay */
        }

        .scene-background-image {
            display: block; 
            width: 100%;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* CSS RESPONSIVE */
        .dialogue-overlay {
            position: relative; 
            z-index: 10;
            /* Điều chỉnh margin âm để đè lên ảnh một cách hợp lý */
            margin-top: -80px; 
            margin-left: 20px;
            margin-right: 20px;
            padding: 25px;
            background: rgba(200, 180, 140, 0.55);  /* Nền sáng hơn, ít trong suốt hơn để dễ đọc */
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            /* backdrop-filter: blur(5px); Hiệu ứng mờ nền phía sau (hoạt động trên Safari/Chrome mới) */
        }
        
        @media (max-width: 600px) {
            .dialogue-overlay {
                margin-top: -40px; /* Ít đè lên hơn trên mobile */
                margin-left: 10px;
                margin-right: 10px;
                padding: 15px;
            }
        }

        .dialogue-display-window {
            color: #333;
            text-align: left;
            min-height: 100px; /* Đảm bảo khung không bị nhảy khi đổi nội dung dài ngắn */
            display: flex;
            flex-direction: column;
        }
        
        /* Style cho các thành phần nội dung hội thoại */
        .speaker-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
        
        }

        .speaker { font-weight: 800; font-size: 1.1rem; margin-right: 10px;}
        /* Màu sắc đại diện cho nhân vật */
        .speaker.suzuki { color: #e67e22; } /* Cam */
        .speaker.tanaka { color: #2980b9; } /* Xanh dương */
        .speaker.an { color: #e84393; } /* Hồng đậm */
        
        .dialogue-content-wrapper {
            display: flex;
            align-items: flex-start; /* Căn hàng trên cùng */
            gap: 15px;
        }

        .dialogue-play-btn { 
            background-color: #228B22; /* Nút màu xanh lá chủ đạo */
            border: none; 
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 1.2rem; cursor: pointer; 
            color: white; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .dialogue-play-btn:hover { background-color: #1e7a1e; transform: scale(1.05); }
        .dialogue-play-btn:active { transform: scale(0.95); }

        .dialogue-texts { flex-grow: 1; }
        
        .japanese-text {
            font-size: clamp(1.2rem, 4vw, 1.6rem); /* Tăng kích thước font tiếng Nhật */
            line-height: 1.8;
            margin: 0 0 8px 0;
            color: #2c3e50;
            font-weight: 500;
        }
        
        /* Tối ưu Furigana */
        ruby { ruby-align: center;}
        rt { font-size: 0.6em; color: #7f8c8d; user-select: none; } 

        .vietnamese-text {
            font-size: 1rem;
            color: #555; 
            margin-top: 0;
            font-style: normal;
            border-left: 3px solid #228B22;
            padding-left: 10px;
        }

        /* Highlight khi đọc */
        .highlight-word {  
            background-color: #fffa90; 
            border-radius: 4px; 
            box-shadow: 0 0 0 1px #f1c40f; /* Viền nhẹ */
        }

        /* Ngữ pháp nổi bật */
        .grammar-point {
            color: #c0392b; 
            font-weight: bold;
            border-bottom: 2px dotted #c0392b; /* Gạch chân chấm bi */
            background-color: rgba(231, 76, 60, 0.05);
            padding: 0 2px;
            border-radius: 3px;
        }

        /* Bảng điều khiển */
        .dialogue-nav { 
            display: flex; justify-content: center; align-items: center; gap: 20px;
            margin-top: 20px;  padding-top: 10px;
        }
        #counter { color: #777; font-weight: 500; min-width: 50px; text-align: center; }
        
        .nav-btn { 
            background-color: white; border: 1px solid #ccc; color: #333; 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease; 
            font-weight: 500; display: flex; align-items: center; gap: 5px;
        }
        .nav-btn:hover:not(:disabled) { background-color: #f9f9f9; border-color: #999; }
        .nav-btn:disabled { opacity: 0.5; cursor: default; background-color: #f0f0f0; border-color: #ddd;}

    </style>
</head>
<body>

    <div class="page-header">
        <h2>Bài 2: Pha cà phê (Thể て & Thể た)</h2>
        <p>Luyện Nghe, Nói, Ngữ pháp, Từ vựng thi JLPT N4</p>
    </div>

    <div class="scene-container">
        <!-- LƯU Ý: Bạn hãy thay ảnh này bằng một ảnh phù hợp với bối cảnh pha cà phê nhé -->
        <img src="lesson2-An-Tanaka1.jpg" alt="Minh họa hội thoại: An và Tanaka pha cà phê" class="scene-background-image">

        <div class="dialogue-overlay">
            
            <!-- Khung hiển thị -->
            <div class="dialogue-display-window"></div>

            <!-- Nguồn dữ liệu (Ẩn) -->
            <div class="dialogue-source" style="display: none;">
                
                <!-- Line 1 -->
                <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">田中 (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">おはよう、アンさん。<ruby>週末<rt>しゅうまつ</rt></ruby>はよく<span class="grammar-point"><ruby>休<rt>やす</rt></ruby>めました</span>か。</p>
                            <p class="vietnamese-text">Chào buổi sáng, An. Cuối tuần em đã nghỉ ngơi tốt chứ?</p>
                        </div>
                    </div>
                </div>

                <!-- Line 2 -->
                <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">アン (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">はい、<ruby>田中<rt>たなか</rt></ruby>さん、おはようございます。<ruby>週末<rt>しゅうまつ</rt></ruby>は<span class="grammar-point"><ruby>休<rt>やす</rt></ruby>んで</span>、<ruby>好<rt>す</rt></ruby>きな<ruby>本<rt>ほん</rt></ruby>を<span class="grammar-point"><ruby>読<rt>よ</rt></ruby>んで</span>、とても<ruby>楽<rt>たの</rt></ruby>しかったです。</p>
                            <p class="vietnamese-text">Vâng, chào buổi sáng anh Tanaka. Cuối tuần em đã nghỉ ngơi, đọc cuốn sách yêu thích, vui lắm ạ.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 3 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">田中 (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">それはよかった。さて、<ruby>朝<rt>あさ</rt></ruby>のミーティングの<ruby>前<rt>まえ</rt></ruby>に、コーヒーを<span class="grammar-point">いれてください</span>。</p>
                            <p class="vietnamese-text">Thế thì tốt quá. Nào, trước cuộc họp sáng, em pha cà phê giúp anh nhé.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 4 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">アン (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">はい、<span class="grammar-point">わかりました</span>。ええと、まず、<ruby>何<rt>なに</rt></ruby>をしますか。</p>
                            <p class="vietnamese-text">Vâng, em hiểu rồi ạ. Ừm, đầu tiên, em làm gì ạ?</p>
                        </div>
                    </div>
                </div>
                
                <!-- Line 5 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">田中 (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">まず、フィルターを<span class="grammar-point">セットして</span>、それからコーヒーの<ruby>粉<rt>こな</rt></ruby>を<ruby>入<rt>い</rt></ruby>れます。</p>
                            <p class="vietnamese-text">Đầu tiên, em lắp bộ lọc vào, rồi cho cà phê bột vào.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 6 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">アン (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">はい、フィルターを<span class="grammar-point">セットして</span>、<ruby>粉<rt>こな</rt></ruby>を<span class="grammar-point"><ruby>い<rt>い</rt></ruby>れました</span>。<ruby>次<rt>つぎ</rt></ruby>は…？</p>
                            <p class="vietnamese-text">Vâng, em đã lắp bộ lọc, và cho bột vào rồi ạ. Tiếp theo là...?</p>
                        </div>
                    </div>
                </div>

                <!-- Line 7 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">田中 (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text"><ruby>次<rt>つぎ</rt></ruby>に、お<ruby>湯<rt>ゆ</rt></ruby>を<span class="grammar-point"><ruby>沸<rt>わ</rt></ruby>かして</span>、ゆっくり<ruby>注<rt>そそ</rt></ruby>ぎます。あ、ちょっと<span class="grammar-point"><ruby>待<rt>ま</rt></ruby>って</span>。そのカップじゃないよ。ミーティング<ruby>用<rt>よう</rt></ruby>のカップを<span class="grammar-point"><ruby>使<rt>つか</rt></ruby>って</span>。</p>
                            <p class="vietnamese-text">Tiếp theo, em đun nước sôi rồi từ từ rót vào. À, khoan đã. Không phải cái cốc đó đâu. Em dùng cốc dành cho cuộc họp ấy.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Line 8 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">アン (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">あ、すみません！はい、カップを<span class="grammar-point">かえました</span>。</p>
                            <p class="vietnamese-text">Á, em xin lỗi! Vâng, em đã đổi cốc rồi ạ.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 9 -->
                <div class="dialogue-line">
                     <div class="speaker-container">
                        <span class="speaker tanaka" data-character="tanaka">田中 (Tanaka)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">うん、ありがとう。コーヒーを<span class="grammar-point"><ruby>い<rt>い</rt></ruby>れた</span><ruby>後<rt>あと</rt></ruby>で、<ruby>資料<rt>しりょう</rt></ruby>を<ruby>会議室<rt>かいぎしつ</rt></ruby>に<span class="grammar-point"><ruby>持<rt>も</rt></ruby>って<ruby>行<rt>い</rt></ruby>って</span>ください。</p>
                            <p class="vietnamese-text">Ừ, cảm ơn em. Sau khi pha cà phê xong, em hãy mang tài liệu đến phòng họp nhé.</p>
                        </div>
                    </div>
                </div>

                <!-- Line 10 -->
                 <div class="dialogue-line">
                    <div class="speaker-container">
                        <span class="speaker an" data-character="an">アン (An)</span>
                    </div>
                    <div class="dialogue-content-wrapper">
                        <button class="dialogue-play-btn" aria-label="Nghe">🔊</button>
                        <div class="dialogue-texts">
                            <p class="japanese-text">はい、<span class="grammar-point"><ruby>承知<rt>しょうち</rt></ruby>しました</span>！</p>
                            <p class="vietnamese-text">Vâng, em rõ rồi ạ!</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Điều hướng -->
            <div class="dialogue-nav">
                <button id="prevBtn" class="nav-btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                    Lùi
                </button>
                <span id="counter">1 / 10</span>
                <button id="nextBtn" class="nav-btn">
                    Tiếp
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="page-footer">
        <p>Phần nội dung tiếp theo của bài học...</p>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // =================================================================
    // === PHẦN 0: BỘ QUẢN LÝ GIỌNG ĐỌC (NÂNG CẤP ƯU TIÊN MICROSOFT) ===
    // =================================================================
    const voiceManager = {
        characterMap: {},
        defaultVoice: null,
        voicesLoaded: false,

        // Cấu hình giọng ưu tiên (keyword để tìm trong tên giọng)
        preferences: {
            'an': 'nanami',      // Ưu tiên Nanami cho An
            'suzuki': 'haruka',  // Ưu tiên Haruka cho Suzuki
            'mio': 'haruka',     // Ưu tiên Haruka cho Mio
            'sato': 'sayaka',    // Ưu tiên Sayaka cho Sato-sensei
            'yamada': 'ichiro',  // Ưu tiên Ichiro cho Yamada-bucho
            'tanaka': 'keita'    // Ưu tiên Keita (hoặc Ichiro) cho Tanaka
        },

        init: function() {
            // Thử tải giọng ngay lập tức
            this.loadVoices();
            
            // Chrome/Edge cần sự kiện này để tải danh sách giọng đầy đủ
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = () => this.loadVoices();
            }
        },

        loadVoices: function() {
            if (this.voicesLoaded) return; // Tránh chạy lại nhiều lần không cần thiết

            const allVoices = speechSynthesis.getVoices();
            if (allVoices.length === 0) return; // Chưa có giọng nào

            // Lọc giọng tiếng Nhật
            const japaneseVoices = allVoices.filter(v => v.lang === 'ja-JP' || v.lang === 'ja_JP');

            if (japaneseVoices.length === 0) {
                console.warn("Không tìm thấy giọng tiếng Nhật.");
                this.voicesLoaded = true;
                return;
            }

            this.defaultVoice = japaneseVoices[0];

            // 1. Tìm các giọng CỤ THỂ theo yêu cầu (Microsoft voices)
            const foundPrefVoices = {};
            japaneseVoices.forEach(voice => {
                const voiceNameLower = voice.name.toLowerCase();
                // Kiểm tra xem giọng này có khớp với từ khóa ưu tiên nào không
                for (const [prefKey, prefKeyword] of Object.entries(this.preferences)) {
                    if (voiceNameLower.includes(prefKeyword)) {
                        foundPrefVoices[prefKeyword] = voice;
                    }
                }
            });

            console.log("Tìm thấy các giọng ưu tiên:", Object.keys(foundPrefVoices));

            // 2. Tạo danh sách dự phòng (Fallback) phân loại Nam/Nữ chung chung
            // Sử dụng regex để đoán giới tính qua tên phổ biến
            const femaleGenerics = japaneseVoices.filter(v => /nanami|haruka|sayaka|ayumi|kyoko|mio/i.test(v.name));
            const maleGenerics = japaneseVoices.filter(v => /ichiro|keita|otoya|kenji|daisuke/i.test(v.name));

            // Hàm trợ giúp để lấy giọng: Ưu tiên -> Dự phòng theo giới tính -> Mặc định
            const assignVoice = (charId, genderList, fallbackIndex) => {
                const prefKeyword = this.preferences[charId];
                // Tầng 1: Nếu có giọng ưu tiên cụ thể
                if (foundPrefVoices[prefKeyword]) {
                    return foundPrefVoices[prefKeyword];
                }
                // Tầng 2: Dùng danh sách dự phòng theo giới tính
                if (genderList.length > 0) {
                    return genderList[fallbackIndex % genderList.length];
                }
                // Tầng 3: Giọng mặc định
                return this.defaultVoice;
            };

            // 3. Thực hiện gán giọng cuối cùng
            this.characterMap = {
                'an': assignVoice('an', femaleGenerics, 0),
                'suzuki': assignVoice('suzuki', femaleGenerics, 1),
                'sato': assignVoice('sato', femaleGenerics, 2),
                'mio': assignVoice('mio', femaleGenerics, 1), // Dùng chung logic dự phòng với Suzuki
                'yamada': assignVoice('yamada', maleGenerics, 0),
                'tanaka': assignVoice('tanaka', maleGenerics, 1),
            };

            console.log("Bản đồ giọng đọc cuối cùng:", 
                Object.fromEntries(Object.entries(this.characterMap).map(([k, v]) => [k, v.name]))
            );
            
            this.voicesLoaded = true;
            
            // Nếu đang ở slide đầu tiên, tải lại để áp dụng giọng (phòng trường hợp voices load chậm)
            if (typeof activateSpeechForCurrentLine === 'function') {
                activateSpeechForCurrentLine();
            }
        },

        getVoiceFor: function(characterName) {
            if (!this.voicesLoaded) this.loadVoices(); // Cố gắng tải lại nếu chưa có
            return this.characterMap[characterName] || this.defaultVoice;
        }
    };

    voiceManager.init();


    // =================================================================
    // === PHẦN 1: BỘ MÁY ĐỌC VÀ HIGHLIGHT (Giữ nguyên logic tốt)    ===
    // =================================================================
    let currentSpeechHandler = null;
    
    function createSpeechHandler(targetElement, characterName) {
        // Lưu HTML gốc (bao gồm thẻ ruby/rt)
        let originalHTML = targetElement.innerHTML;
        let charMap = []; 
        let plainText = '';
        let utterance = null;
        let isPlaying = false;
        let isPaused = false;

        // Hàm chuẩn bị: Tách từng ký tự để highlight, nhưng giữ nguyên cấu trúc Ruby
        function _prepareForSpeech() {
            plainText = '';
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalHTML;

            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    plainText += node.textContent;
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // Bỏ qua nội dung trong thẻ <rt> (furigana) khi lấy plainText đọc
                    if (node.tagName === 'RT') return;
                    Array.from(node.childNodes).forEach(processNode);
                }
            }

            processNode(tempDiv);
            
            // Bọc span cho các ký tự có thể highlight được
            const tempDivForHighlight = document.createElement('div');
            tempDivForHighlight.innerHTML = originalHTML;

            function wrapCharacters(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const fragment = document.createDocumentFragment();
                    for (const char of node.textContent) {
                        const span = document.createElement('span');
                        span.textContent = char;
                        fragment.appendChild(span);
                    }
                    node.parentNode.replaceChild(fragment, node);
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.tagName === 'RT') return; // Không bọc furigana
                    Array.from(node.childNodes).forEach(wrapCharacters);
                }
            }
            
            wrapCharacters(tempDivForHighlight);
            targetElement.innerHTML = tempDivForHighlight.innerHTML;
            
            // Lấy danh sách tất cả các span có thể highlight
            charMap = Array.from(targetElement.querySelectorAll('span')).filter(span => {
                 return !span.closest('rt') && !span.classList.contains('grammar-point');
            });
        }

        function _cleanup() {
            // Khôi phục HTML gốc (xóa các thẻ span highlight)
            targetElement.innerHTML = originalHTML;
            isPlaying = false;
            isPaused = false;
            const btn = displayWindow.querySelector('.dialogue-play-btn');
            if(btn) btn.innerHTML = '🔊'; // Reset icon
        }

        function play() {
            if (currentSpeechHandler && currentSpeechHandler !== this) {
                currentSpeechHandler.stop();
            }
            currentSpeechHandler = this;
            const btn = displayWindow.querySelector('.dialogue-play-btn');

            if (isPlaying && isPaused) {
                speechSynthesis.resume();
                isPaused = false;
                if(btn) btn.innerHTML = '⏸';
                return;
            }
            
            if (isPlaying && !isPaused) {
                speechSynthesis.pause();
                isPaused = true;
                if(btn) btn.innerHTML = '▶';
                return;
            }
            
            speechSynthesis.cancel();
            
            _prepareForSpeech();
            isPlaying = true;
            isPaused = false;
            if(btn) btn.innerHTML = '⏸';
            
            utterance = new SpeechSynthesisUtterance(plainText);
            utterance.lang = 'ja-JP';
            utterance.rate = 1; 

            const assignedVoice = voiceManager.getVoiceFor(characterName);
            if (assignedVoice) {
                utterance.voice = assignedVoice;
            }

            utterance.onboundary = (event) => {
                if (event.name !== 'word') return;
                
                const highlighted = targetElement.querySelectorAll('.highlight-word');
                highlighted.forEach(el => el.classList.remove('highlight-word'));

                for (let i = 0; i < event.charLength; i++) {
                    const charIndex = event.charIndex + i;
                    if (charMap[charIndex]) {
                        charMap[charIndex].classList.add('highlight-word');
                    }
                }
            };

            utterance.onend = () => {
                _cleanup();
                currentSpeechHandler = null;
            };
            
            utterance.onerror = (event) => {
                console.error('Lỗi đọc:', event);
                _cleanup();
                currentSpeechHandler = null;
            };
            
            speechSynthesis.speak(utterance);
        }

        function stop() {
            if(isPlaying || isPaused) {
                speechSynthesis.cancel();
                _cleanup();
                currentSpeechHandler = null;
            }
        }

        return { play, stop, get isPlaying() { return isPlaying; } };
    }

    // =================================================================
    // === PHẦN 2: ĐIỀU KHIỂN HỘI THOẠI (SLIDESHOW)                  ===
    // =================================================================
    const displayWindow = document.querySelector('.dialogue-display-window');
    const sourceLines = document.querySelectorAll('.dialogue-source .dialogue-line');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const counter = document.getElementById('counter');
    
    let currentIndex = 0;
    const totalLines = sourceLines.length;
    let currentLineHandler = null;

    window.activateSpeechForCurrentLine = function() {
        if (currentLineHandler) {
            currentLineHandler.stop();
        }
        
        const currentPlayBtn = displayWindow.querySelector('.dialogue-play-btn');
        const currentTextElement = displayWindow.querySelector('.japanese-text');
        const currentSpeakerElement = displayWindow.querySelector('.speaker');

        if (currentPlayBtn && currentTextElement && currentSpeakerElement) {
            const characterName = currentSpeakerElement.dataset.character;
            currentLineHandler = createSpeechHandler(currentTextElement, characterName);
            
            const newBtn = currentPlayBtn.cloneNode(true);
            currentPlayBtn.parentNode.replaceChild(newBtn, currentPlayBtn);
            
            newBtn.addEventListener('click', () => {
                currentLineHandler.play();
            });
        }
    }

    function showLine(index) {
        if (index >= 0 && index < totalLines) {
            displayWindow.style.opacity = 0;
            
            setTimeout(() => {
                if (currentLineHandler) currentLineHandler.stop();
                displayWindow.innerHTML = sourceLines[index].innerHTML;
                window.activateSpeechForCurrentLine(); 
                counter.textContent = `${index + 1} / ${totalLines}`;
                
                updateNavButtons();
                displayWindow.style.opacity = 1; 
            }, 150);
        }
    }
    
    displayWindow.style.transition = 'opacity 0.15s ease';

    function updateNavButtons() {
        prevBtn.disabled = (currentIndex === 0);
        nextBtn.disabled = (currentIndex === totalLines - 1);
    }

    nextBtn.addEventListener('click', () => {
        if (currentIndex < totalLines - 1) {
            currentIndex++;
            showLine(currentIndex);
        }
    });

    prevBtn.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            showLine(currentIndex);
        }
    });

    // Khởi chạy
    if (totalLines > 0) {
        showLine(0);
    }
});
</script>
</body>
</html>
